<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amplify 2026 ‚Äî Partner Dashboard</title>
  <script src="data.js?v=202602191408"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* ‚îÄ‚îÄ Fora brand fonts ‚îÄ‚îÄ */
    @font-face {
      font-family: 'ChiswickSansText';
      src: url('fonts/ChiswickSansText-Regular.otf') format('opentype');
      font-weight: 400; font-display: swap;
    }
    @font-face {
      font-family: 'ChiswickSansText';
      src: url('fonts/ChiswickSansText-Semibold.otf') format('opentype');
      font-weight: 600; font-display: swap;
    }
    @font-face {
      font-family: 'Blanco';
      src: url('fonts/Blanco-Regular.otf') format('opentype');
      font-weight: 400; font-display: swap;
    }
    @font-face {
      font-family: 'Blanco';
      src: url('fonts/Blanco-Bold.otf') format('opentype');
      font-weight: 700; font-display: swap;
    }
    @font-face {
      font-family: 'Blanco';
      src: url('fonts/Blanco-Italic.otf') format('opentype');
      font-weight: 400; font-style: italic; font-display: swap;
    }

    :root {
      /* Fora Primary Palette */
      --navy: #131313;        /* Black Sand */
      --navy-mid: #1e1e1e;
      --bg: #fefaf5;          /* Sand */
      --white: #ffffff;
      --text: #131313;
      --text-light: #827363;  /* Stone */
      --border: #e5dbd0;      /* Shell */
      /* Fora Accent Palette */
      --olive: #77742a;
      --sangria: #870d13;
      --indigo: #333880;
      --stone: #827363;
      --shell: #e5dbd0;
      --dark-sand: #f3ebe2;
      /* Semantic aliases kept for compatibility */
      --gold: #77742a;        /* Olive ‚Äî primary accent on light bg */
      --gold-light: #e5dbd0;  /* Shell ‚Äî warm cream accent on dark bg */
      --green: #77742a;       /* Olive ‚Äî paid/positive */
      --amber: #333880;       /* Indigo ‚Äî pipeline/in-discussion */
      --red: #870d13;         /* Sangria ‚Äî outstanding/urgent */
      --shadow: 0 2px 12px rgba(0,0,0,0.07);
      --radius: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Blanco', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .sticky-chrome {
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header {
      background: var(--navy);
      color: white;
      padding: 28px 40px 24px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      box-shadow: 0 2px 20px rgba(0,0,0,0.3);
    }
    .header-left h1 { font-family: 'ChiswickSansText', sans-serif; font-size: 22px; font-weight: 600; letter-spacing: 0.01em; color: var(--gold-light); }
    .header-left p { font-size: 13px; color: rgba(255,255,255,0.5); margin-top: 2px; }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .week-badge {
      background: rgba(119,116,42,0.18);
      border: 1px solid var(--gold);
      color: var(--gold-light);
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }

    /* ‚îÄ‚îÄ NAV TABS ‚îÄ‚îÄ */
    .nav-tabs {
      background: var(--navy-mid);
      padding: 0 40px;
      display: flex;
      gap: 2px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      overflow-x: auto;
    }
    .nav-tab {
      padding: 11px 18px 13px;
      color: rgba(255,255,255,0.45);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      user-select: none;
      white-space: nowrap;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .nav-tab-name { font-size: 13px; font-weight: 600; line-height: 1.2; }
    .nav-tab-desc { font-size: 10px; font-weight: 400; opacity: 0.75; letter-spacing: 0.01em; }
    .nav-tab:hover { color: rgba(255,255,255,0.8); }
    .nav-tab.active { color: var(--gold-light); border-bottom-color: var(--gold); }
    .nav-tab.active .nav-tab-desc { opacity: 1; }

    /* ‚îÄ‚îÄ OVERVIEW DROPDOWN ‚îÄ‚îÄ */
    .nav-tab-wrapper { position: relative; }
    .nav-tab-wrapper:hover .nav-dropdown { display: block; }
    .nav-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--navy-mid);
      border: 1px solid rgba(255,255,255,0.12);
      border-top: none;
      border-radius: 0 0 8px 8px;
      min-width: 210px;
      z-index: 200;
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
      padding: 4px 0;
    }
    .nav-dropdown a {
      display: block;
      padding: 9px 18px;
      color: rgba(255,255,255,0.65);
      text-decoration: none;
      font-size: 12.5px;
      white-space: nowrap;
      transition: background 0.12s, color 0.12s;
    }
    .nav-dropdown a:hover { background: rgba(255,255,255,0.07); color: var(--gold-light); }

    /* ‚îÄ‚îÄ SECTIONS ‚îÄ‚îÄ */
    .section { display: none; padding: 32px 40px; max-width: 1400px; margin: 0 auto; }
    .section.active { display: block; }

    /* ‚îÄ‚îÄ KPI CARDS ‚îÄ‚îÄ */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }
    .kpi-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 22px 24px;
      box-shadow: var(--shadow);
      border-left: 4px solid transparent;
      position: relative;
      overflow: hidden;
    }
    .kpi-card::after {
      content: '';
      position: absolute;
      top: 0; right: 0;
      width: 60px; height: 60px;
      border-radius: 50%;
      background: var(--kpi-color, #eee);
      opacity: 0.08;
      transform: translate(20px, -20px);
    }
    .kpi-card.gold { border-left-color: var(--gold); --kpi-color: var(--gold); }
    .kpi-card.green { border-left-color: var(--green); --kpi-color: var(--green); }
    .kpi-card.amber { border-left-color: var(--amber); --kpi-color: var(--amber); }
    .kpi-card.red { border-left-color: var(--red); --kpi-color: var(--red); }
    .kpi-card.navy { border-left-color: var(--navy); --kpi-color: var(--navy); }
    .kpi-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-light); margin-bottom: 8px; }
    .kpi-value { font-size: 28px; font-weight: 700; color: var(--text); line-height: 1; }
    .kpi-sub { font-size: 12px; color: var(--text-light); margin-top: 6px; }
    .kpi-delta { display: inline-block; font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px; margin-top: 6px; }
    .kpi-delta.up { background: #ecedd8; color: #444418; }
    .kpi-delta.warn { background: #e8e9f3; color: #2a2e6e; }

    /* ‚îÄ‚îÄ CHART GRID ‚îÄ‚îÄ */
    .chart-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    .chart-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    .chart-card { background: var(--white); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); }
    .chart-card.wide { grid-column: 1 / -1; }
    .chart-card h3 { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-light); margin-bottom: 20px; }
    .chart-wrap { position: relative; }

    /* ‚îÄ‚îÄ SECTION TITLE ‚îÄ‚îÄ */
    .section-title { font-family: 'ChiswickSansText', sans-serif; font-size: 22px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
    .section-subtitle { font-size: 13px; color: var(--text-light); margin-bottom: 28px; }

    /* ‚îÄ‚îÄ PIPELINE OVERVIEW ‚îÄ‚îÄ */
    .pipeline-seg-bar { display: flex; height: 10px; border-radius: 8px; overflow: hidden; margin-bottom: 14px; gap: 2px; }
    .pipeline-seg { height: 100%; border-radius: 4px; transition: width 0.7s cubic-bezier(0.4,0,0.2,1); }
    .pipeline-seg-labels { display: flex; flex-wrap: wrap; gap: 6px 20px; margin-bottom: 24px; }
    .pipeline-seg-label { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-light); }
    .pipeline-seg-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .pipeline-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 0 32px; }
    .pipeline-col-hdr { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-light); padding-bottom: 8px; border-bottom: 2px solid var(--border); margin-bottom: 2px; margin-top: 0; }
    .pipeline-col-hdr.mt { margin-top: 20px; }
    .pl-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .pl-row:last-child { border-bottom: none; }
    .pl-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .pl-name { flex: 1; font-size: 13px; font-weight: 500; }
    .pl-count { font-size: 14px; font-weight: 700; color: var(--text); text-align: right; min-width: 28px; }
    .pl-val { font-size: 12px; color: var(--text-light); text-align: right; min-width: 64px; }

    /* ‚îÄ‚îÄ NEW THIS WEEK BANNER ‚îÄ‚îÄ */
    .new-banner { background: var(--dark-sand); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; margin-bottom: 20px; display: flex; align-items: flex-start; gap: 14px; }
    .new-banner-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--olive); flex-shrink: 0; margin-top: 5px; }
    .new-banner-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--olive); margin-bottom: 6px; }
    .new-banner-chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .new-chip { display: inline-flex; align-items: center; gap: 6px; background: var(--white); border: 1px solid var(--border); border-radius: 20px; padding: 4px 12px; font-size: 12px; cursor: pointer; transition: border-color 0.15s, box-shadow 0.15s; }
    .new-chip:hover { border-color: var(--olive); box-shadow: 0 0 0 2px rgba(119,116,42,0.12); }
    .new-chip-name { font-weight: 600; color: var(--text); }
    .new-chip-stage { color: var(--text-light); }

    /* ‚îÄ‚îÄ DELIVERABLE CALENDAR ‚îÄ‚îÄ */
    .cal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
    .cal-month { background: var(--white); border: 1px solid var(--border); border-radius: 10px; padding: 14px 16px; }
    .cal-month-name { font-family: 'ChiswickSansText', sans-serif; font-size: 14px; font-weight: 600; margin-bottom: 10px; color: var(--text); }
    .cal-month.past .cal-month-name { color: var(--text-light); }
    .cal-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; border-bottom: 1px solid var(--border); }
    .cal-row:last-child { border-bottom: none; }
    .cal-type { flex: 1; font-size: 12px; color: var(--text); }
    .cal-counts { display: flex; gap: 4px; align-items: center; font-size: 11px; }
    .cal-done { color: var(--olive); font-weight: 700; }
    .cal-planned { color: var(--indigo); font-weight: 700; }
    .cal-total { font-size: 13px; font-weight: 700; color: var(--text-light); text-align: right; }

    /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead tr { border-bottom: 2px solid var(--border); }
    thead th { padding: 10px 14px; text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-light); white-space: nowrap; }
    thead th.sortable { cursor: pointer; user-select: none; }
    thead th.sortable:hover { color: var(--text); }
    thead th.sort-active { color: var(--olive); }
    .sort-icon { display: inline-block; margin-left: 4px; opacity: 0.35; font-style: normal; }
    thead th.sort-active .sort-icon { opacity: 1; }
    tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
    tbody tr:hover { background: #fafaf8; cursor: pointer; }
    tbody td { padding: 11px 14px; color: var(--text); }
    .badge { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 600; white-space: nowrap; }
    .badge-green { background: #ecedd8; color: #444418; }   /* olive tint */
    .badge-amber { background: #e8e9f3; color: #2a2e6e; }   /* indigo tint */
    .badge-red   { background: #f5e8e9; color: #870d13; }   /* sangria */
    .badge-navy  { background: #e8e9f3; color: #333880; }   /* indigo */
    .badge-gold  { background: #ecedd8; color: #444418; }   /* olive tint */
    .badge-gray  { background: #ede9e5; color: #63574a; }   /* dark stone */
    .badge-teal  { background: #e8e9f3; color: #333880; }   /* indigo */

    /* ‚îÄ‚îÄ GEO + BRANDS ‚îÄ‚îÄ */
    .leaderboard { display: flex; flex-direction: column; gap: 6px; }
    .lb-item { display: flex; align-items: center; gap: 10px; }
    .lb-rank { width: 22px; text-align: center; font-size: 11px; font-weight: 700; color: var(--text-light); }
    .lb-label { flex: 1; font-size: 13px; font-weight: 500; }
    .lb-bar-wrap { width: 100px; background: #f0eeea; border-radius: 4px; height: 6px; }
    .lb-bar { height: 100%; border-radius: 4px; background: var(--gold); }
    .lb-count { width: 28px; text-align: right; font-size: 13px; font-weight: 700; color: var(--text); }

    /* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
    .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .filter-btn { padding: 7px 16px; border-radius: 20px; border: 1px solid var(--border); background: white; font-size: 12px; font-weight: 600; cursor: pointer; color: var(--text-light); transition: all 0.15s; }
    .filter-btn.active, .filter-btn:hover { background: var(--navy); color: white; border-color: var(--navy); }

    /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
    .search-input-wrap { position: relative; flex: 1; min-width: 260px; }
    .search-input {
      width: 100%;
      padding: 10px 16px 10px 40px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      background: white;
      outline: none;
      transition: border-color 0.15s;
    }
    .search-input:focus { border-color: var(--gold); }
    .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-light); font-size: 16px; pointer-events: none; }
    .search-select {
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
      background: white;
      color: var(--text);
      outline: none;
      cursor: pointer;
    }
    .search-select:focus { border-color: var(--gold); }
    .result-count { font-size: 13px; color: var(--text-light); padding: 4px 0; }

    /* ‚îÄ‚îÄ PARTNER DETAIL DRAWER ‚îÄ‚îÄ */
    .partner-detail {
      display: none;
      background: #fafaf8;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px 24px;
      margin: 0;
    }
    .partner-detail.open { display: block; }
    .detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px 24px; margin-bottom: 16px; }
    .detail-field label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-light); display: block; margin-bottom: 3px; }
    .detail-field span { font-size: 13px; color: var(--text); }
    .feature-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }

    /* ‚îÄ‚îÄ NEXT STEPS ‚îÄ‚îÄ */
    .next-steps-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
    .next-step-card { background: var(--white); border-radius: var(--radius); padding: 20px 24px; box-shadow: var(--shadow); display: flex; gap: 16px; align-items: flex-start; }
    .step-number { width: 32px; height: 32px; border-radius: 50%; background: var(--navy); color: var(--gold-light); font-size: 14px; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .step-content h4 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .step-content p { font-size: 13px; color: var(--text-light); line-height: 1.5; }
    .step-tag { display: inline-block; margin-top: 8px; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    .step-tag.urgent { background: #f5e8e9; color: #870d13; }
    .step-tag.this-week { background: #e8e9f3; color: #2a2e6e; }
    .step-tag.ongoing { background: #ede9e5; color: #827363; }
    .step-tag.nice { background: #ecedd8; color: #444418; }

    /* ‚îÄ‚îÄ TEAM UPDATES ‚îÄ‚îÄ */
    .updates-area { background: var(--white); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); margin-bottom: 24px; }
    .updates-area h3 { font-size: 15px; font-weight: 600; margin-bottom: 16px; }
    .update-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
    .update-item { display: flex; gap: 12px; padding: 14px 16px; border-radius: 8px; border: 1px solid var(--border); background: #fafaf8; }
    .update-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
    .update-dot.gold { background: var(--gold); }
    .update-dot.green { background: var(--green); }
    .update-dot.amber { background: var(--amber); }
    .update-dot.navy { background: var(--navy); }
    .update-text { font-size: 13px; line-height: 1.5; }
    .notes-box { width: 100%; min-height: 100px; border: 1px solid var(--border); border-radius: 8px; padding: 12px 14px; font-size: 13px; color: var(--text); font-family: inherit; resize: vertical; background: #fafaf8; outline: none; }
    .notes-box:focus { border-color: var(--gold); }
    .notes-label { font-size: 12px; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; }

    /* ‚îÄ‚îÄ SCENARIO PLANNER ‚îÄ‚îÄ */
    .planner-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
    .planner-card { background: var(--white); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); }
    .planner-card h3 { font-size: 15px; font-weight: 700; margin-bottom: 20px; color: var(--text); }
    .goal-input-wrap { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
    .goal-input {
      flex: 1;
      padding: 14px 18px;
      border: 2px solid var(--gold);
      border-radius: 10px;
      font-size: 22px;
      font-weight: 700;
      font-family: inherit;
      color: var(--text);
      background: white;
      outline: none;
      max-width: 280px;
    }
    .goal-label { font-size: 13px; color: var(--text-light); }
    .progress-wrap { margin-bottom: 24px; }
    .progress-label-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
    .progress-label { font-size: 13px; font-weight: 600; color: var(--text); }
    .progress-pct { font-size: 22px; font-weight: 700; color: var(--olive); }
    .progress-bar-bg { width: 100%; height: 16px; background: #ede9e5; border-radius: 8px; overflow: hidden; }
    .progress-bar-fg { height: 100%; border-radius: 8px; background: linear-gradient(90deg, var(--olive), #a3a040); transition: width 0.5s ease; }
    .gap-amount { font-size: 28px; font-weight: 700; }
    .gap-label { font-size: 13px; color: var(--text-light); margin-top: 4px; }

    .scenario-list { display: flex; flex-direction: column; gap: 16px; }
    .scenario-card { border: 1px solid var(--border); border-radius: 10px; padding: 16px 20px; background: #fafaf8; }
    .scenario-card h4 { font-size: 14px; font-weight: 700; margin-bottom: 10px; }
    .scenario-rows { display: flex; flex-direction: column; gap: 6px; }
    .scenario-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
    .scenario-row .pkg { color: var(--text-light); }
    .scenario-row .qty { font-weight: 700; color: var(--text); }

    .pkg-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    .pkg-table th { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-light); padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border); }
    .pkg-table td { padding: 10px 12px; font-size: 13px; border-bottom: 1px solid #f0eeea; }
    .pkg-table tr:last-child td { border-bottom: none; }
    .pkg-price-input { width: 90px; padding: 4px 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; font-family: inherit; text-align: right; outline: none; }
    .pkg-price-input:focus { border-color: var(--gold); }
    .mini-progress { height: 6px; background: #f0eeea; border-radius: 3px; margin-top: 4px; overflow: hidden; }
    .mini-progress-fill { height: 100%; border-radius: 3px; background: var(--gold); }

    /* ‚îÄ‚îÄ ACCORDION ‚îÄ‚îÄ */
    .acc-header { display: flex; align-items: center; justify-content: space-between; padding: 18px 0; cursor: pointer; border-bottom: 2px solid var(--border); margin-bottom: 24px; user-select: none; transition: border-color 0.15s; }
    .acc-header:hover { border-bottom-color: var(--olive); }
    .acc-header:hover .acc-title { color: var(--olive); }
    .acc-title { font-family: 'ChiswickSansText', sans-serif; font-size: 19px; font-weight: 600; color: var(--text); }
    .acc-meta { font-size: 12px; color: var(--text-light); margin-top: 3px; }
    .acc-chevron { font-size: 14px; color: var(--stone); transition: transform 0.22s ease; flex-shrink: 0; margin-left: 16px; }
    .acc-header.closed .acc-chevron { transform: rotate(-90deg); }
    .acc-body { margin-bottom: 8px; }
    .acc-body.closed { display: none; }

    /* ‚îÄ‚îÄ AMOUNT ‚îÄ‚îÄ */
    .amount { font-variant-numeric: tabular-nums; }

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media (max-width: 900px) {
      .kpi-grid { grid-template-columns: 1fr 1fr; }
      .chart-grid-2, .chart-grid-3, .planner-grid, .next-steps-grid { grid-template-columns: 1fr; }
      .section { padding: 24px 20px; }
      .header { padding: 20px; }
      .nav-tabs { padding: 0 20px; }
      .detail-grid { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 600px) {
      .kpi-grid { grid-template-columns: 1fr; }
      .detail-grid { grid-template-columns: 1fr; }
    }

    /* ‚îÄ‚îÄ ASSETS TAB ‚îÄ‚îÄ */
    .assets-form-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px 28px; margin-bottom: 24px; }
    .assets-form-two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 28px; align-items: start; }
    .af-field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; }
    .af-field label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--text-light); }
    .af-input { font-size: 13px; font-family: inherit; border: 1px solid var(--border); border-radius: 7px; padding: 8px 12px; background: var(--bg); outline: none; color: var(--text); }
    .af-input:focus { border-color: var(--olive); }
    .partner-selector { border: 1px solid var(--border); border-radius: 7px; background: var(--bg); }
    .partner-selector-search { padding: 8px 12px; border-bottom: 1px solid var(--border); }
    .partner-selector-search input { width: 100%; border: none; background: transparent; font-size: 13px; font-family: inherit; outline: none; color: var(--text); }
    .partner-selector-list { max-height: 380px; overflow-y: auto; }
    .partner-selector-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; cursor: pointer; font-size: 13px; transition: background 0.1s; }
    .partner-selector-item:hover { background: var(--dark-sand); }
    .partner-selector-item:has(input:checked) { background: rgba(119,116,42,0.12); font-weight: 600; color: var(--olive); }
    .partner-selector-item.ps-focus { background: var(--dark-sand); outline: 2px solid var(--olive); outline-offset: -2px; }
    .partner-selector-item input[type="checkbox"] { cursor: pointer; accent-color: var(--olive); width: 15px; height: 15px; flex-shrink: 0; }
    .partner-selector-actions { padding: 6px 12px; border-top: 1px solid var(--border); display: flex; gap: 12px; align-items: center; }
    .partner-selector-actions button { font-size: 11px; color: var(--olive); background: none; border: none; cursor: pointer; font-family: inherit; font-weight: 600; }
    .asset-upload-preview { width: 100%; max-height: 280px; border-radius: 8px; object-fit: contain; border: 1px solid var(--border); margin-top: 8px; background: var(--sand); }
    .pending-badge { background: var(--sangria); color: white; border-radius: 10px; padding: 2px 8px; font-size: 11px; font-weight: 700; margin-left: 8px; vertical-align: middle; }
    /* Live assets ‚Äî small grid cards */
    .asset-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
    .asset-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    .asset-card-thumb { width: 100%; height: 150px; object-fit: cover; background: var(--dark-sand); display: block; }
    .asset-card-body { padding: 14px 16px; }
    .asset-card-deliv { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--olive); margin-bottom: 4px; }
    .asset-card-label { font-size: 14px; font-weight: 600; margin-bottom: 8px; font-family: 'ChiswickSansText', sans-serif; }
    .asset-card-meta { font-size: 12px; color: var(--text-light); margin-bottom: 12px; line-height: 1.6; }
    .asset-card-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    /* Pending review ‚Äî wide two-column cards */
    .review-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px 28px; margin-bottom: 16px; }
    .review-card-two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; align-items: start; }
    .review-card-img { width: 100%; max-height: 380px; border-radius: 8px; object-fit: contain; border: 1px solid var(--border); background: var(--dark-sand); display: block; }
    .review-card-pdf { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 260px; background: var(--dark-sand); border-radius: 8px; text-decoration: none; color: var(--text); gap: 10px; font-size: 13px; border: 1px solid var(--border); }
    .review-card-deliv { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--olive); margin-bottom: 6px; }
    .review-card-label { font-size: 17px; font-weight: 600; font-family: 'ChiswickSansText', sans-serif; margin-bottom: 18px; }
    .review-card-section-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--text-light); margin-bottom: 8px; }
    .review-card-actions { display: flex; gap: 10px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border); }
    .btn-approve { background: var(--olive); color: white; border: none; padding: 7px 14px; border-radius: 7px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; }
    .btn-approve:disabled { opacity: .5; cursor: default; }
    .btn-reject  { background: white; color: var(--sangria); border: 1px solid var(--sangria); padding: 7px 14px; border-radius: 7px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; }
    .btn-remove  { background: white; color: var(--text-light); border: 1px solid var(--border); padding: 7px 14px; border-radius: 7px; font-size: 12px; font-weight: 600; cursor: pointer; font-family: inherit; }
    .partner-chip { display: inline-flex; align-items: center; gap: 4px; background: var(--sand); border-radius: 4px; padding: 2px 6px; margin: 2px 2px 2px 0; font-size: 11px; }
    .btn-unlink { background: none; border: none; color: var(--text-light); font-size: 13px; line-height: 1; cursor: pointer; padding: 0 1px; font-weight: 700; }
    .btn-unlink:hover { color: var(--sangria); }
    .draft-add-wrap { position: relative; margin-top: 6px; }
    .draft-add-input { width: 100%; box-sizing: border-box; padding: 5px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; font-family: inherit; background: var(--sand); }
    .draft-add-dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border); border-radius: 6px; box-shadow: 0 4px 16px rgba(0,0,0,0.12); z-index: 50; max-height: 180px; overflow-y: auto; }
    .dad-item { padding: 7px 12px; font-size: 12px; cursor: pointer; }
    .dad-item:hover { background: var(--sand); }
    /* Overview jump nav */
    .overview-jumpnav { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; background: var(--sand); border-left: 3px solid var(--olive); border-radius: 8px; padding: 10px 16px; margin-bottom: 24px; font-size: 12px; color: var(--text-light); position: sticky; top: 0; z-index: 10; }
    .overview-jumpnav span { margin-right: 2px; font-weight: 600; color: var(--olive); }
    .overview-jumpnav a { color: var(--olive); text-decoration: none; cursor: pointer; padding: 3px 10px; background: white; border: 1px solid rgba(119,116,42,0.3); border-radius: 20px; font-size: 12px; transition: all 0.15s; white-space: nowrap; }
    .overview-jumpnav a:hover { background: var(--olive); color: white; border-color: var(--olive); }
    /* Settings modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal-box { background: white; border-radius: var(--radius); padding: 28px 32px; max-width: 460px; width: 90%; box-shadow: 0 8px 40px rgba(0,0,0,0.22); }
    .modal-box h3 { font-size: 16px; font-weight: 700; margin-bottom: 8px; font-family: 'ChiswickSansText', sans-serif; }
    .modal-close { float: right; background: none; border: none; font-size: 22px; cursor: pointer; color: var(--text-light); margin-top: -4px; line-height: 1; }
    .gear-btn { background: none; border: none; color: rgba(255,255,255,0.45); font-size: 18px; cursor: pointer; padding: 4px 6px; line-height: 1; transition: color 0.15s; }
    .gear-btn:hover { color: rgba(255,255,255,0.9); }
    .assets-no-token { background: #fdf6e3; border: 1px solid #c9a800; border-radius: 8px; padding: 12px 16px; font-size: 13px; margin-bottom: 20px; }
    /* Live assets grouped by month */
    .live-group { border: 1px solid var(--border); border-radius: var(--radius); background: var(--white); margin-bottom: 10px; overflow: hidden; }
    .live-group-header { display: flex; align-items: center; gap: 10px; padding: 13px 16px; cursor: pointer; user-select: none; background: var(--dark-sand); }
    .live-group-header:hover { background: var(--shell); }
    .live-group-title { font-size: 13px; font-weight: 700; font-family: 'ChiswickSansText', sans-serif; }
    .live-group-count { font-size: 12px; color: var(--text-light); }
    .live-group-chevron { margin-left: auto; font-size: 11px; color: var(--text-light); transition: transform 0.2s; }
    .live-group.open .live-group-chevron { transform: rotate(180deg); }
    .live-group-body { display: none; }
    .live-group.open .live-group-body { display: block; }
    /* Live asset sub-groups (deliverable level) */
    .live-subgroup { border-top: 1px solid var(--border); }
    .live-subgroup-header { display: flex; align-items: center; gap: 8px; padding: 9px 16px 9px 22px; cursor: pointer; user-select: none; background: var(--white); }
    .live-subgroup-header:hover { background: var(--dark-sand); }
    .live-subgroup-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--stone); }
    .live-subgroup-count { font-size: 11px; color: var(--text-light); }
    .live-subgroup-chevron { margin-left: auto; font-size: 10px; color: var(--text-light); transition: transform 0.2s; }
    .live-subgroup.open .live-subgroup-chevron { transform: rotate(180deg); }
    .live-subgroup-body { display: none; }
    .live-subgroup.open .live-subgroup-body { display: block; }
    /* Duplicate notice above partner selector */
    .ps-dup-notice { background: #fdf6e3; border: 1px solid #c9a800; border-radius: 7px; padding: 7px 12px; font-size: 12px; font-weight: 600; color: #7a5c00; margin-bottom: 6px; display: none; }
    .live-row { display: flex; align-items: center; gap: 14px; padding: 11px 16px; border-top: 1px solid var(--border); }
    .live-row-preview { flex-shrink: 0; }
    .live-row-info { flex: 1; min-width: 0; }
    .live-row-deliv { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: var(--olive); }
    .live-row-partners { font-size: 12px; color: var(--text-light); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 500px; }
    /* Asset type toggle (File / URL) */
    .af-type-toggle { display: flex; border: 1px solid var(--border); border-radius: 7px; overflow: hidden; width: fit-content; margin-bottom: 14px; }
    .af-type-btn { padding: 7px 18px; font-size: 12px; font-weight: 600; font-family: inherit; cursor: pointer; background: none; border: none; color: var(--text-light); transition: all 0.15s; }
    .af-type-btn.active { background: var(--olive); color: white; }
    /* Duplicate flag on partner items */
    .ps-dup-flag { margin-left: auto; font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 10px; white-space: nowrap; flex-shrink: 0; pointer-events: none; }
    .ps-dup-flag.draft { background: #fdf6e3; color: #7a5c00; border: 1px solid #c9a800; }
    .ps-dup-flag.live  { background: #fdf6e3; color: #7a5c00; border: 1px solid #c9a800; }
    /* Needs Review panel */
    .nr-panel { background: #fffbf0; border: 1px solid #c9a800; border-radius: 10px; margin-bottom: 16px; overflow: hidden; }
    .nr-panel-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; cursor: pointer; user-select: none; font-weight: 600; font-size: 13px; color: #7a5c00; }
    .nr-panel-header:hover { background: #fdf6e3; }
    .nr-panel-body { border-top: 1px solid #e8d87a; }
    .nr-panel-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; border-bottom: 1px solid #f3edd4; font-size: 13px; gap: 12px; }
    .nr-panel-row:last-child { border-bottom: none; }
    .nr-missing-list { font-size: 11px; color: #7a5c00; margin-top: 2px; opacity: 0.85; }
    /* Progress bar in search table */
    .prog-bar-wrap { background: #e9e4dd; border-radius: 4px; height: 5px; width: 60px; overflow: hidden; display: inline-block; vertical-align: middle; margin-left: 6px; }
    .prog-bar-fill { display: block; height: 5px; border-radius: 4px; background: var(--olive, #77742A); }
    .prog-cell { font-size: 12px; color: var(--text-main); white-space: nowrap; }
  </style>
</head>
<body>

<!-- STICKY CHROME (header + nav) -->
<div class="sticky-chrome">
  <div class="header">
    <div class="header-left">
      <div style="display:flex; align-items:center; gap:14px; margin-bottom:6px;">
        <span style="font-family:'ChiswickSansText',sans-serif; font-size:11px; font-weight:600; letter-spacing:0.18em; text-transform:uppercase; color:var(--gold); border:1px solid var(--gold); padding:4px 10px; border-radius:4px;">FORA</span>
        <span style="width:1px; height:22px; background:rgba(255,255,255,0.2);"></span>
        <span style="font-size:11px; font-weight:600; letter-spacing:0.1em; text-transform:uppercase; color:rgba(255,255,255,0.4);">Travel Partners</span>
      </div>
      <h1>Amplify 2026 ‚Äî Internal Dashboard</h1>
      <p id="headerSubtitle">Loading data‚Ä¶</p>
    </div>
    <div class="header-right">
      <span class="week-badge" id="weekBadge">‚Äî</span>
      <button class="gear-btn" onclick="openSettings()" title="Settings">‚öô</button>
    </div>
  </div>

  <!-- NAV TABS -->
  <div class="nav-tabs">
    <div class="nav-tab active" onclick="showTab('overview',this)">
      <span class="nav-tab-name">Overview</span>
      <span class="nav-tab-desc">Metrics, planning & team tools</span>
    </div>
    <div class="nav-tab" onclick="showTab('search',this)">
      <span class="nav-tab-name">Partners</span>
      <span class="nav-tab-desc">Search & manage partners</span>
    </div>
    <div class="nav-tab" onclick="showTab('assets',this)">
      <span class="nav-tab-name">Assets</span>
      <span class="nav-tab-desc">Upload & review partner content</span>
    </div>
  </div>
</div>


<!-- ===== OVERVIEW ===== -->
<div id="tab-overview" class="section active">
  <h2 class="section-title">Amplify 2026</h2>
  <p class="section-subtitle" id="overviewSubtitle">Full program status as of this week's data export.</p>

  <div class="overview-jumpnav">
    <span>Jump to:</span>
    <a onclick="jumpToSection('glance')">At a Glance</a>
    <a onclick="jumpToSection('invoicing')">Invoicing</a>
    <a onclick="jumpToSection('calendar')">Deliverable Calendar</a>
    <a onclick="jumpToSection('planner')">Revenue Planner</a>
    <a onclick="jumpToSection('priorities')">Priorities</a>
    <a onclick="jumpToSection('team-acc')">Team</a>
  </div>

  <!-- ‚îÄ‚îÄ NEW THIS WEEK ‚îÄ‚îÄ -->
  <div id="newThisWeekBanner" style="display:none;"></div>

  <!-- ‚îÄ‚îÄ AT A GLANCE ‚îÄ‚îÄ -->
  <div class="acc-header closed" id="acc-hdr-glance" onclick="toggleSection('glance')">
    <div>
      <div class="acc-title">At a Glance</div>
      <div class="acc-meta">Key numbers, revenue breakdown, and pipeline.</div>
    </div>
    <div class="acc-chevron">‚ñº</div>
  </div>
  <div class="acc-body" id="acc-body-glance">
    <div class="kpi-grid">
      <div class="kpi-card gold">
        <div class="kpi-label">Signed Partners</div>
        <div class="kpi-value" id="kpiSignedCount">‚Äî</div>
        <div class="kpi-sub">Tier 1 ¬∑ Brand Spotlight ¬∑ Tier 2 ¬∑ New Opening ¬∑ Marketing Complete</div>
      </div>
      <div class="kpi-card navy">
        <div class="kpi-label">Total Value Signed</div>
        <div class="kpi-value" id="kpiTotalSigned">‚Äî</div>
        <div class="kpi-sub">Across all signed packages</div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-label">Collected (Paid)</div>
        <div class="kpi-value" id="kpiPaid">‚Äî</div>
        <div class="kpi-sub" id="kpiPaidSub">‚Äî</div>
        <span class="kpi-delta" id="paidTrackBadge">‚Äî</span>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-label">Total Value in Pipeline</div>
        <div class="kpi-value" id="kpiTotalPipeline">‚Äî</div>
        <div class="kpi-sub">Signed + In Discussion + Needs Invoice</div>
      </div>
    </div>

    <div class="kpi-grid" style="grid-template-columns: repeat(4,1fr); margin-bottom:32px;">
      <div class="kpi-card amber">
        <div class="kpi-label">In Discussion</div>
        <div class="kpi-value" id="kpiInDiscussion">‚Äî</div>
        <div class="kpi-sub" id="kpiInDiscussionSub">‚Äî</div>
      </div>
      <div class="kpi-card red">
        <div class="kpi-label">Needs Invoice</div>
        <div class="kpi-value" id="kpiNeedsInvoice">‚Äî</div>
        <div class="kpi-sub" id="kpiNeedsInvoiceSub">‚Äî</div>
      </div>
      <div class="kpi-card navy">
        <div class="kpi-label">Final Follow Up</div>
        <div class="kpi-value" id="kpiFinalFollowUp">‚Äî</div>
        <div class="kpi-sub" id="kpiFinalFollowUpSub">‚Äî</div>
      </div>
      <div class="kpi-card gold">
        <div class="kpi-label">Marketing Complete</div>
        <div class="kpi-value" id="kpiMarketingComplete">‚Äî</div>
        <div class="kpi-sub">Deliverables fulfilled</div>
      </div>
    </div>

    <div class="chart-grid-2">
      <div class="chart-card">
        <h3>Revenue by Package</h3>
        <div class="chart-wrap" style="height:240px;"><canvas id="revenueChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Invoice Collection Status</h3>
        <div class="chart-wrap" style="height:240px;"><canvas id="invoiceChart"></canvas></div>
      </div>
    </div>

    <div class="chart-grid-3">
      <div class="chart-card">
        <h3>Signed Partners by Tier</h3>
        <div class="chart-wrap" style="height:200px;"><canvas id="tierChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Deliverable Quarter Preference</h3>
        <div class="chart-wrap" style="height:200px;"><canvas id="quarterChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Feature Deliverables (Signed)</h3>
        <div class="chart-wrap" style="height:200px;"><canvas id="featuresChart"></canvas></div>
      </div>
    </div>

    <div class="chart-grid-2" style="margin-top:4px;">
      <div class="chart-card wide">
        <h3>Signed Partners Over Time</h3>
        <div class="chart-wrap" style="height:220px;"><canvas id="signedOverTimeChart"></canvas></div>
      </div>
    </div>

    <div style="margin-top:4px;">
      <div class="chart-card">
        <h3>Full Pipeline ‚Äî All Stages</h3>
        <div id="funnelList"></div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ INVOICING ‚îÄ‚îÄ -->
  <div class="acc-header closed" id="acc-hdr-invoicing" onclick="toggleSection('invoicing')">
    <div>
      <div class="acc-title">Invoicing</div>
      <div class="acc-meta" id="invoiceSubtitle">Invoice status across all signed partners.</div>
    </div>
    <div class="acc-chevron">‚ñº</div>
  </div>
  <div class="acc-body" id="acc-body-invoicing">
    <div class="kpi-grid" style="margin-bottom:28px;">
      <div class="kpi-card green">
        <div class="kpi-label">Paid</div>
        <div class="kpi-value" id="invPaid">‚Äî</div>
        <div class="kpi-sub" id="invPaidSub">‚Äî</div>
      </div>
      <div class="kpi-card red">
        <div class="kpi-label">Outstanding</div>
        <div class="kpi-value" id="invOutstanding">‚Äî</div>
        <div class="kpi-sub">Invoices sent, awaiting payment</div>
      </div>
      <div class="kpi-card amber">
        <div class="kpi-label">Waiting on Billing Info</div>
        <div class="kpi-value" id="invWaiting">‚Äî</div>
        <div class="kpi-sub" id="invWaitingSub">‚Äî</div>
      </div>
      <div class="kpi-card navy">
        <div class="kpi-label">Needs Invoice Sent</div>
        <div class="kpi-value" id="invNeedsInvoice">‚Äî</div>
        <div class="kpi-sub" id="invNeedsInvoiceSub">‚Äî</div>
      </div>
    </div>

    <div class="chart-card">
      <h3>Partners Needing Invoices ‚Äî Action Required</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Partner Name</th>
              <th>Package</th>
              <th>Amount</th>
              <th>Country</th>
              <th>Priority</th>
              <th>Streak</th>
            </tr>
          </thead>
          <tbody id="needsInvoiceTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ PARTNER OVERVIEW ‚îÄ‚îÄ -->
  <div class="acc-header closed" id="acc-hdr-partners" onclick="toggleSection('partners')">
    <div>
      <div class="acc-title">Partner Overview</div>
      <div class="acc-meta">Geography, hotel groups, brands, and deliverables.</div>
    </div>
    <div class="acc-chevron">‚ñº</div>
  </div>
  <div class="acc-body" id="acc-body-partners">
    <div class="chart-grid-3">
      <div class="chart-card">
        <h3>Top Countries</h3>
        <div class="leaderboard" id="countryLeaderboard"></div>
      </div>
      <div class="chart-card">
        <h3>Top Hotel Groups</h3>
        <div class="leaderboard" id="groupLeaderboard"></div>
      </div>
      <div class="chart-card">
        <h3>Top Brands</h3>
        <div class="leaderboard" id="brandLeaderboard"></div>
      </div>
    </div>

    <div class="chart-grid-2">
      <div class="chart-card">
        <h3>Partner Mix by Package</h3>
        <div class="chart-wrap" style="height:220px;"><canvas id="partnerTypeChart"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>Feature Deliverables (Signed)</h3>
        <div class="chart-wrap" style="height:220px;"><canvas id="featuresChart2"></canvas></div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ DELIVERABLE CALENDAR ‚îÄ‚îÄ -->
  <div class="acc-header closed" id="acc-hdr-calendar" onclick="toggleSection('calendar')">
    <div>
      <div class="acc-title">Deliverable Calendar</div>
      <div class="acc-meta" id="calendarMeta">Monthly view of all signed partner deliverables.</div>
    </div>
    <div class="acc-chevron">‚ñº</div>
  </div>
  <div class="acc-body closed" id="acc-body-calendar">
    <div class="cal-grid" id="calGrid"></div>
  </div>

  <!-- ‚îÄ‚îÄ REVENUE PLANNER ‚îÄ‚îÄ -->
  <div class="acc-header closed" id="acc-hdr-planner" onclick="toggleSection('planner')">
    <div>
      <div class="acc-title">Revenue Planner</div>
      <div class="acc-meta">Set a goal and model what package mix gets you there.</div>
    </div>
    <div class="acc-chevron">‚ñº</div>
  </div>
  <div class="acc-body closed" id="acc-body-planner">
    <div class="planner-grid">
      <div class="planner-card">
        <h3>Revenue Goal</h3>
        <div class="goal-input-wrap">
          <div style="font-size:22px; font-weight:700; color:var(--text-light);">$</div>
          <input type="text" class="goal-input" id="goalInput" value="1,500,000" oninput="fmtGoalInput(this); updatePlanner()">
        </div>
        <div class="progress-wrap">
          <div class="progress-label-row">
            <span class="progress-label">Current progress</span>
            <span class="progress-pct" id="plannerPct">‚Äî%</span>
          </div>
          <div class="progress-bar-bg">
            <div class="progress-bar-fg" id="plannerProgressBar" style="width:0%"></div>
          </div>
          <div style="display:flex; justify-content:space-between; margin-top:6px;">
            <span style="font-size:12px; color:var(--text-light);" id="plannerSignedLabel">‚Äî</span>
            <span style="font-size:12px; color:var(--text-light);" id="plannerGoalLabel">‚Äî</span>
          </div>
        </div>
        <div style="display:flex; gap:24px;">
          <div>
            <div class="kpi-label">Gap to close</div>
            <div class="gap-amount" id="plannerGap" style="color:var(--red);">‚Äî</div>
            <div class="gap-label">additional revenue needed</div>
          </div>
          <div>
            <div class="kpi-label">Pipeline available</div>
            <div class="gap-amount" id="plannerPipelineAvail" style="color:var(--amber);">‚Äî</div>
            <div class="gap-label">in active discussions</div>
          </div>
        </div>
      </div>
      <div class="planner-card">
        <h3>Package Pricing (editable)</h3>
        <table class="pkg-table">
          <thead><tr><th>Package</th><th>Price</th><th>Current</th><th>Revenue</th></tr></thead>
          <tbody id="pkgPricingTable"></tbody>
        </table>
      </div>
    </div>
    <div class="chart-card" style="margin-bottom:24px;">
      <h3>How to close the gap ‚Äî 3 scenarios</h3>
      <div id="scenarioList" class="scenario-list"></div>
    </div>
    <div class="chart-card">
      <h3>Package Breakdown ‚Äî Current Signed</h3>
      <div id="fillRateTable"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ PRIORITIES ‚îÄ‚îÄ -->
  <div class="acc-header closed" id="acc-hdr-priorities" onclick="toggleSection('priorities')">
    <div>
      <div class="acc-title">Priorities</div>
      <div class="acc-meta">Data-driven action items for the week ahead.</div>
    </div>
    <div class="acc-chevron">‚ñº</div>
  </div>
  <div class="acc-body closed" id="acc-body-priorities">
    <div class="next-steps-grid" id="nextStepsGrid"></div>
  </div>

  <!-- ‚îÄ‚îÄ TEAM ‚îÄ‚îÄ -->
  <div class="acc-header" id="acc-hdr-team-acc" onclick="toggleSection('team-acc')">
    <div>
      <div class="acc-title">Team</div>
      <div class="acc-meta">Weekly highlights and notes for team sharing.</div>
    </div>
    <div class="acc-chevron">‚ñº</div>
  </div>
  <div class="acc-body closed" id="acc-body-team-acc">
    <div class="updates-area">
      <h3>This Week's Highlights</h3>
      <div class="update-list" id="updateList"></div>
      <div class="notes-label">Weekly Notes (add context before sharing)</div>
      <textarea class="notes-box" id="weeklyNotes" placeholder="Add any team notes, context, or updates here before sharing this dashboard‚Ä¶"></textarea>
    </div>
    <div class="chart-card" style="margin-bottom:24px;">
      <h3>Program Snapshot ‚Äî Copy-Paste Summary</h3>
      <div id="copySnapshot" style="background:#fafaf8; border:1px solid var(--border); border-radius:8px; padding:16px; font-size:13px; line-height:1.8; white-space:pre-wrap; font-family:monospace;"></div>
      <button onclick="copySnapshot()" style="margin-top:12px; padding:8px 20px; background:var(--navy); color:white; border:none; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer;">Copy Summary</button>
    </div>
  </div>

</div>


<!-- ===== PARTNER SEARCH ===== -->
<div id="tab-search" class="section">
  <h2 class="section-title">Partner Search</h2>
  <p class="section-subtitle">Look up any partner to view their package, invoice status, deliverables, and contact details.</p>

  <div class="filter-bar">
    <div class="search-input-wrap">
      <span class="search-icon">üîç</span>
      <input type="text" class="search-input" id="partnerSearch" placeholder="Search by name, brand, group, or country‚Ä¶" oninput="filterPartners()">
    </div>
    <select class="search-select" id="stageFilter" onchange="filterPartners()">
      <option value="">All Stages</option>
      <option value="Tier 1">Tier 1</option>
      <option value="Tier 2">Tier 2</option>
      <option value="Brand Spotlight">Brand Spotlight</option>
      <option value="New Opening">New Opening</option>
      <option value="Marketing Complete">Marketing Complete</option>
      <option value="Needs Invoice">Needs Invoice</option>
      <option value="In Discussion">In Discussion</option>
      <option value="Final Follow Up">Final Follow Up</option>
      <option value="Needs Contact">Needs Contact</option>
      <option value="Declined">Declined</option>
      <option value="Do Not Invite">Do Not Invite</option>
    </select>
    <select class="search-select" id="invoiceFilter" onchange="filterPartners()">
      <option value="">All Invoice Statuses</option>
      <option value="Paid">Paid</option>
      <option value="Outstanding">Outstanding</option>
      <option value="To Invoice">To Invoice</option>
      <option value="Waiting for billing details">Waiting for billing details</option>
      <option value="In Kind Sponsorship">In Kind Sponsorship</option>
    </select>
    <select class="search-select" id="quarterFilter" onchange="filterPartners()">
      <option value="">All Deliverable Quarters</option>
      <option value="Q1">Q1</option>
      <option value="Q2">Q2</option>
      <option value="Q3">Q3</option>
      <option value="Q4">Q4</option>
      <option value="TBD">TBD (none set)</option>
    </select>
  </div>
  <div class="result-count" id="searchResultCount"></div>

  <div id="needs-review-section" style="display:none; margin-top:16px;"></div>

  <div class="chart-card" style="padding: 0; overflow: hidden; margin-top: 12px;">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="sortable" onclick="sortPartners('name')" id="sth-name">Partner Name <i class="sort-icon">‚Üï</i></th>
            <th class="sortable" onclick="sortPartners('stageKey')" id="sth-stageKey">Stage <i class="sort-icon">‚Üï</i></th>
            <th class="sortable" onclick="sortPartners('price')" id="sth-price">Amount <i class="sort-icon">‚Üï</i></th>
            <th class="sortable" onclick="sortPartners('invoiceStatus')" id="sth-invoiceStatus">Invoice Status <i class="sort-icon">‚Üï</i></th>
            <th class="sortable" onclick="sortPartners('quarters')" id="sth-quarters">Deliverable Quarter(s) <i class="sort-icon">‚Üï</i></th>
            <th class="sortable" onclick="sortPartners('country')" id="sth-country">Country <i class="sort-icon">‚Üï</i></th>
            <th class="sortable" onclick="sortPartners('progress')" id="sth-progress">Progress <i class="sort-icon">‚Üï</i></th>
            <th>Links</th>
          </tr>
        </thead>
        <tbody id="partnerSearchTbody"></tbody>
      </table>
    </div>
  </div>
</div>




<!-- ===== ASSETS ===== -->
<div id="tab-assets" class="section">
  <h2 class="section-title">Partner Assets</h2>
  <p class="section-subtitle">Upload screenshots of completed deliverables and apply them to one or more partners. Assets go live on partner portals after your approval.</p>

  <div id="assets-no-token-banner" class="assets-no-token" style="display:none;">
    <strong>Access code required</strong> ‚Äî click the ‚öô gear icon in the top-right corner to enter your GitHub access code. Team members: ask Margaux for the code.
  </div>

  <!-- Upload form -->
  <div class="assets-form-card">
    <h3 style="font-size:14px;font-weight:700;margin-bottom:20px;font-family:'ChiswickSansText',sans-serif;">Upload New Asset</h3>
    <div class="assets-form-two-col">

      <!-- Left: file + details -->
      <div>
        <div class="af-type-toggle">
          <button class="af-type-btn active" onclick="setAssetType('file',this)">Upload File</button>
          <button class="af-type-btn" onclick="setAssetType('url',this)">Add Link (URL)</button>
        </div>
        <div id="af-section-file">
          <div class="af-field">
            <label>File (image or PDF)</label>
            <input id="af-file" type="file" accept="image/*,.pdf" class="af-input" onchange="previewUploadImg(this)">
            <img id="af-preview" class="asset-upload-preview" style="display:none;" alt="Preview">
            <div id="af-preview-pdf" style="display:none;margin-top:10px;padding:16px;background:var(--sand);border-radius:8px;font-size:14px;text-align:center;">üìÑ <span id="af-preview-pdf-name"></span></div>
          </div>
        </div>
        <div id="af-section-url" style="display:none;">
          <div class="af-field">
            <label>URL</label>
            <input id="af-url" type="url" class="af-input" placeholder="https://www.instagram.com/p/‚Ä¶">
          </div>
        </div>
        <div class="af-field">
          <label>Deliverable</label>
          <select id="af-deliverable" class="af-input" onchange="updateLabelPreview()">
            <option value="">Select deliverable‚Ä¶</option>
            <option>Collection</option>
            <option>Newsletter</option>
            <option>Forum</option>
            <option>Advisor Assets</option>
            <option>Webinar</option>
            <option>Social Media</option>
            <option>Journal Article</option>
          </select>
        </div>
        <div class="af-field">
          <label>Month</label>
          <select id="af-month" class="af-input" onchange="updateLabelPreview()">
            <option value="">Select month‚Ä¶</option>
            <option>January</option><option>February</option><option>March</option>
            <option>April</option><option>May</option><option>June</option>
            <option>July</option><option>August</option><option>September</option>
            <option>October</option><option>November</option><option>December</option>
          </select>
        </div>
        <div id="af-label-preview" style="font-size:12px;color:var(--text-light);padding:2px 0 10px;min-height:18px;"></div>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:4px;">
          <button onclick="submitAsset(this)" class="btn-approve" style="padding:10px 22px;font-size:13px;">Submit for review</button>
          <span id="af-status" style="font-size:12px;"></span>
        </div>
      </div>

      <!-- Right: partner selector -->
      <div class="af-field" style="margin-bottom:0;">
        <label>Apply to Partners <span id="ps-count" style="font-weight:400;font-size:11px;color:var(--olive);margin-left:6px;"></span></label>
        <div class="partner-selector">
          <div class="partner-selector-search">
            <input type="text" id="ps-search" placeholder="Search partners‚Ä¶" oninput="filterPartnerSelector(this.value)" onkeydown="psSearchKeydown(event)">
          </div>
          <div class="ps-dup-notice" id="ps-dup-notice"></div>
          <div class="partner-selector-list" id="ps-list">
            <div style="padding:12px;color:var(--text-light);font-size:13px;">Loading partners‚Ä¶</div>
          </div>
          <div class="partner-selector-actions">
            <button onclick="selectAllPartners()">Select all visible</button>
            <button onclick="clearAllPartners()">Clear</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Pending review -->
  <div class="acc-section" style="margin-bottom:24px;">
    <div class="acc-header" id="acc-hdr-pending" onclick="toggleSection('pending')">
      Pending Review <span id="pending-badge" class="pending-badge" style="display:none;"></span>
    </div>
    <div class="acc-body open" id="acc-body-pending">
      <div id="pending-cards">
        <p style="color:var(--text-light);font-size:13px;">No assets pending review.</p>
      </div>
    </div>
  </div>

  <!-- Live assets -->
  <div class="acc-section">
    <div class="acc-header" id="acc-hdr-live" onclick="toggleSection('live')">Live Assets</div>
    <div class="acc-body open" id="acc-body-live">
      <div id="live-cards">
        <p style="color:var(--text-light);font-size:13px;">No live assets yet.</p>
      </div>
    </div>
  </div>
</div>


<!-- Settings modal -->
<div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeSettings()">
  <div class="modal-box">
    <button class="modal-close" onclick="closeSettings()">√ó</button>
    <h3 id="settings-modal-title">One-time setup required</h3>
    <p style="font-size:13px;color:var(--text-light);margin:8px 0 20px;line-height:1.6;">
      To upload and review assets, you need to enter an access code once. It will be saved in your browser so you never need to enter it again.<br><br>
      <strong>Don't have the code?</strong> Ask Margaux ‚Äî she can share it with you directly.
    </p>
    <div class="af-field" style="margin-bottom:16px;">
      <label>Access Code</label>
      <input id="settings-token" type="password" class="af-input" placeholder="Paste code here‚Ä¶" autocomplete="off">
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <button onclick="saveSettings()" class="btn-approve">Save</button>
      <button onclick="clearSettings()" class="btn-remove">Clear saved code</button>
    </div>
    <p id="settings-status" style="margin-top:12px;font-size:12px;display:none;"></p>
  </div>
</div>


<script>
// ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(tab, el) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  if (el) el.classList.add('active');
  if (tab === 'assets') { buildPartnerSelector(); loadAssetsTab(); _prefetchPublicAssets(); if (!ghToken()) openSettings(); }
  if (tab === 'search') { _prefetchPublicAssets(); buildNeedsReview(); }
  localStorage.setItem('amplifyTab', tab);
}

// ‚îÄ‚îÄ Public asset cache (no token needed) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _liveAssets      = null;   // status === 'live' only
let _allAssets       = null;   // all statuses (for duplicate detection)
let _publicAssetsFetch = null;

function _prefetchPublicAssets() {
  if (_publicAssetsFetch) return;
  _publicAssetsFetch = fetch('partner-resources.json?' + Date.now(), { cache: 'no-store' })
    .then(r => r.json())
    .then(json => {
      _allAssets  = json.assets || [];
      _liveAssets = _allAssets.filter(a => a.status === 'live');
    })
    .catch(() => { _allAssets = []; _liveAssets = []; });
}

async function _awaitLiveAssets() {
  if (_liveAssets !== null) return;
  if (!_publicAssetsFetch) _prefetchPublicAssets();
  await _publicAssetsFetch;
}

// ‚îÄ‚îÄ Jump to Overview section from dropdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function jumpToSection(id) {
  // Switch to overview tab if needed
  const overviewTab = document.querySelector('.nav-tab[onclick*="\'overview\'"]');
  showTab('overview', overviewTab);
  // Open accordion if closed
  const body = document.getElementById('acc-body-' + id);
  if (body && body.classList.contains('closed')) body.classList.remove('closed');
  // Scroll to the header
  setTimeout(() => {
    const hdr = document.getElementById('acc-hdr-' + id);
    if (hdr) hdr.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 60);
}

// ‚îÄ‚îÄ Copy partner portal link to clipboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copyPartnerLink(key, btn) {
  const url = window.location.origin + window.location.pathname.replace('index.html','').replace(/\/$/, '') + '/partner.html?key=' + key;
  navigator.clipboard.writeText(url).then(() => {
    const orig = btn.textContent;
    btn.textContent = 'Copied!';
    btn.style.background = '#1a6b3a';
    setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 2000);
  });
}

// ‚îÄ‚îÄ GitHub API helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GH_REPO   = 'margaux-noel/amplify-2026-dashboard';
const GH_BRANCH = 'main';
function ghToken() { return localStorage.getItem('amplify_gh_token') || ''; }

async function ghGetFile(path) {
  if (!ghToken()) throw new Error('No access code set.');
  const r = await fetch(`https://api.github.com/repos/${GH_REPO}/contents/${encodeURIComponent(path)}?ref=${GH_BRANCH}`, {
    cache: 'no-store',
    headers: { 'Authorization': `token ${ghToken()}`, 'Accept': 'application/vnd.github.v3+json' }
  });
  if (!r.ok) { const e = await r.json().catch(() => ({})); throw new Error(e.message || `GitHub ${r.status}`); }
  const d = await r.json();
  return { content: decodeURIComponent(escape(atob(d.content.replace(/\s/g,'')))), sha: d.sha };
}

async function ghPutFile(path, content, sha, message) {
  const encoded = btoa(unescape(encodeURIComponent(content)));
  const body = { message, content: encoded, branch: GH_BRANCH };
  if (sha) body.sha = sha;
  const r = await fetch(`https://api.github.com/repos/${GH_REPO}/contents/${encodeURIComponent(path)}`, {
    method: 'PUT',
    headers: { 'Authorization': `token ${ghToken()}`, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!r.ok) { const e = await r.json().catch(() => ({})); throw new Error(e.message || `GitHub ${r.status}`); }
  return r.json();
}

async function ghUploadImage(path, file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = async e => {
      const base64 = e.target.result.split(',')[1];
      try {
        const r = await fetch(`https://api.github.com/repos/${GH_REPO}/contents/${encodeURIComponent(path)}`, {
          method: 'PUT',
          headers: { 'Authorization': `token ${ghToken()}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: `Upload asset: ${path}`, content: base64, branch: GH_BRANCH })
        });
        if (!r.ok) { const e2 = await r.json().catch(() => ({})); reject(new Error(e2.message || `GitHub ${r.status}`)); return; }
        resolve(await r.json());
      } catch(err) { reject(err); }
    };
    reader.onerror = () => reject(new Error('Could not read file'));
    reader.readAsDataURL(file);
  });
}

async function ghDeleteFile(path, sha) {
  const r = await fetch(`https://api.github.com/repos/${GH_REPO}/contents/${encodeURIComponent(path)}`, {
    method: 'DELETE',
    headers: { 'Authorization': `token ${ghToken()}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: `Remove asset: ${path}`, sha, branch: GH_BRANCH })
  });
  if (!r.ok) { const e = await r.json().catch(() => ({})); throw new Error(e.message || `GitHub ${r.status}`); }
  return r.json();
}

// ‚îÄ‚îÄ Settings modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSettings() {
  const hasToken = !!ghToken();
  document.getElementById('settings-modal-title').textContent = hasToken ? 'Access Code' : 'One-time setup required';
  document.getElementById('settings-token').value = ghToken();
  document.getElementById('settings-status').style.display = 'none';
  document.getElementById('settingsModal').classList.add('open');
}
function closeSettings() { document.getElementById('settingsModal').classList.remove('open'); }
function saveSettings() {
  const val = document.getElementById('settings-token').value.trim();
  if (!val) return;
  localStorage.setItem('amplify_gh_token', val);
  const s = document.getElementById('settings-status');
  s.textContent = '‚úì Access code saved.'; s.style.color = 'var(--olive)'; s.style.display = 'block';
  document.getElementById('assets-no-token-banner').style.display = 'none';
  setTimeout(closeSettings, 1200);
}
function clearSettings() {
  localStorage.removeItem('amplify_gh_token');
  document.getElementById('settings-token').value = '';
  const s = document.getElementById('settings-status');
  s.textContent = 'Access code cleared.'; s.style.color = 'var(--text-light)'; s.style.display = 'block';
}

// ‚îÄ‚îÄ Partner selector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SIGNED_STAGES_SET = new Set(['Tier 1','Tier 2','Brand Spotlight','New Opening','Marketing Complete']);
let _partnerSelectorBuilt = false;

function buildPartnerSelector() {
  if (_partnerSelectorBuilt) return;
  _partnerSelectorBuilt = true;
  const partners = (typeof AMPLIFY_DATA !== 'undefined' ? AMPLIFY_DATA.partners : [])
    .filter(p => SIGNED_STAGES_SET.has(p.stage))
    .sort((a, b) => a.name.localeCompare(b.name));
  document.getElementById('ps-list').innerHTML = partners.map(p =>
    `<label class="partner-selector-item" data-key="${p.key}">
      <input type="checkbox" value="${p.key}" onchange="updatePartnerCount()">
      <span>${p.name}</span>
    </label>`
  ).join('');
}

function filterPartnerSelector(q) {
  const low = q.toLowerCase();
  document.querySelectorAll('#ps-list .partner-selector-item').forEach(el => {
    el.style.display = el.querySelector('span').textContent.toLowerCase().includes(low) ? '' : 'none';
  });
  _psFocusIdx = -1;
  document.querySelectorAll('#ps-list .partner-selector-item').forEach(el => el.classList.remove('ps-focus'));
}

let _psFocusIdx = -1;

function psSearchKeydown(e) {
  const visible = [...document.querySelectorAll('#ps-list .partner-selector-item')].filter(el => el.style.display !== 'none');
  if (!visible.length) return;
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    _psFocusIdx = Math.min(_psFocusIdx + 1, visible.length - 1);
    _psHighlight(visible);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    _psFocusIdx = Math.max(_psFocusIdx - 1, 0);
    _psHighlight(visible);
  } else if (e.key === 'Enter' && _psFocusIdx >= 0) {
    e.preventDefault();
    const cb = visible[_psFocusIdx].querySelector('input[type="checkbox"]');
    cb.checked = !cb.checked;
    updatePartnerCount();
  }
}

function _psHighlight(visible) {
  document.querySelectorAll('#ps-list .partner-selector-item').forEach(el => el.classList.remove('ps-focus'));
  if (_psFocusIdx >= 0 && _psFocusIdx < visible.length) {
    visible[_psFocusIdx].classList.add('ps-focus');
    visible[_psFocusIdx].scrollIntoView({ block: 'nearest' });
  }
}
function selectAllPartners() {
  document.querySelectorAll('#ps-list .partner-selector-item:not([style*="none"]) input').forEach(cb => cb.checked = true);
  updatePartnerCount();
}
function clearAllPartners() {
  document.querySelectorAll('#ps-list input[type="checkbox"]').forEach(cb => cb.checked = false);
  updatePartnerCount();
}
function updatePartnerCount() {
  const list = document.getElementById('ps-list');
  const items = [...list.querySelectorAll('.partner-selector-item')];
  // Float checked items to the top
  items.sort((a, b) => (b.querySelector('input').checked ? 1 : 0) - (a.querySelector('input').checked ? 1 : 0));
  items.forEach(el => list.appendChild(el));
  const n = items.filter(el => el.querySelector('input').checked).length;
  document.getElementById('ps-count').textContent = n ? `${n} selected` : '';
}

function updateLabelPreview() {
  const deliv = document.getElementById('af-deliverable').value;
  const month = document.getElementById('af-month').value;
  const el = document.getElementById('af-label-preview');
  if (deliv && month) {
    el.textContent = `Label: "${month} ${deliv} Feature"`;
    el.style.color = 'var(--olive)';
  } else {
    el.textContent = (deliv || month) ? 'Select both deliverable and month to preview' : '';
    el.style.color = 'var(--text-light)';
  }
  updateDelivFlags();
}

async function updateDelivFlags() {
  // Clear existing flags and notice
  document.querySelectorAll('#ps-list .ps-dup-flag').forEach(el => el.remove());
  const notice = document.getElementById('ps-dup-notice');
  if (notice) { notice.style.display = 'none'; notice.textContent = ''; }
  const deliv = document.getElementById('af-deliverable').value;
  const month = document.getElementById('af-month').value;
  if (!deliv || !month) return;
  if (!_publicAssetsFetch) _prefetchPublicAssets();
  await _publicAssetsFetch;
  const targetLabel = `${month} ${deliv} Feature`;
  // Match on deliverable + month anywhere in label (handles label variations)
  const matches = (_allAssets || []).filter(a =>
    a.deliverable === deliv && (_labelMonth(a.label) || '').toLowerCase() === month.toLowerCase()
  );
  const flaggedKeys = new Set();
  matches.forEach(a => {
    (a.partnerKeys || []).forEach(key => {
      const item = document.querySelector(`#ps-list .partner-selector-item[data-key="${key}"]`);
      if (!item) return;
      if (item.querySelector('.ps-dup-flag')) return;
      const flag = document.createElement('span');
      flag.className = `ps-dup-flag ${a.status === 'live' ? 'live' : 'draft'}`;
      flag.textContent = a.status === 'live' ? '‚ö† already live' : '‚ö† pending';
      flag.title = `Already has "${a.label}" (${a.status})`;
      item.appendChild(flag);
      flaggedKeys.add(key);
    });
  });
  // Show summary notice
  if (notice && flaggedKeys.size > 0) {
    const liveCount = matches.filter(a => a.status === 'live').reduce((s, a) => s + (a.partnerKeys || []).length, 0);
    notice.textContent = `‚ö† ${flaggedKeys.size} partner${flaggedKeys.size !== 1 ? 's' : ''} already have a ${deliv} asset for ${month} ‚Äî flagged below`;
    notice.style.display = 'block';
  }
}

function setAssetType(type, btn) {
  document.querySelectorAll('.af-type-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('af-section-file').style.display = type === 'file' ? '' : 'none';
  document.getElementById('af-section-url').style.display  = type === 'url'  ? '' : 'none';
}
function previewUploadImg(input) {
  const img = document.getElementById('af-preview');
  const pdf = document.getElementById('af-preview-pdf');
  img.style.display = 'none'; pdf.style.display = 'none';
  if (!input.files || !input.files[0]) return;
  const file = input.files[0];
  if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
    document.getElementById('af-preview-pdf-name').textContent = file.name;
    pdf.style.display = '';
  } else {
    img.src = URL.createObjectURL(file); img.style.display = '';
  }
}

// ‚îÄ‚îÄ Submit asset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitAsset(btn) {
  if (!ghToken()) { openSettings(); return; }
  const isUrl = document.getElementById('af-section-url').style.display !== 'none';
  const deliv = document.getElementById('af-deliverable').value;
  const month = document.getElementById('af-month').value;
  const label = (month && deliv) ? `${month} ${deliv} Feature` : deliv;
  const file  = document.getElementById('af-file').files[0];
  const url   = document.getElementById('af-url').value.trim();
  const keys  = [...document.querySelectorAll('#ps-list input:checked')].map(cb => cb.value);
  const st    = document.getElementById('af-status');
  if (!deliv) { st.textContent = 'Please select a deliverable.'; st.style.color = 'var(--sangria)'; return; }
  if (!month) { st.textContent = 'Please select a month.'; st.style.color = 'var(--sangria)'; return; }
  if (isUrl && !url)  { st.textContent = 'Please enter a URL.'; st.style.color = 'var(--sangria)'; return; }
  if (!isUrl && !file){ st.textContent = 'Please select a file.'; st.style.color = 'var(--sangria)'; return; }
  if (!keys.length) { st.textContent = 'Please select at least one partner.'; st.style.color = 'var(--sangria)'; return; }
  btn.disabled = true; st.style.color = 'var(--text-light)';
  try {
    const ts = Date.now();
    let assetRecord;
    if (isUrl) {
      st.textContent = 'Saving record‚Ä¶';
      assetRecord = { id: String(ts), deliverable: deliv, label, url, path: '', assetType: 'url', partnerKeys: keys, status: 'draft', uploadedAt: new Date().toISOString() };
    } else {
      st.textContent = 'Uploading file‚Ä¶';
      const ext  = file.name.split('.').pop().toLowerCase() || 'png';
      const slug = deliv.toLowerCase().replace(/[^a-z0-9]+/g, '-');
      const imgPath = `partner-assets/${slug}-${ts}.${ext}`;
      await ghUploadImage(imgPath, file);
      st.textContent = 'Saving record‚Ä¶';
      assetRecord = { id: String(ts), deliverable: deliv, label, path: imgPath, partnerKeys: keys, status: 'draft', uploadedAt: new Date().toISOString() };
    }
    let resData;
    try { resData = await ghGetFile('partner-resources.json'); }
    catch(e) { resData = { content: '{"assets":[]}', sha: null }; }
    const json = JSON.parse(resData.content);
    if (!json.assets) json.assets = [];
    json.assets.push(assetRecord);
    await ghPutFile('partner-resources.json', JSON.stringify(json, null, 2), resData.sha, `Add draft asset: ${label}`);
    // Invalidate asset cache so flags refresh
    _allAssets = null; _liveAssets = null; _publicAssetsFetch = null;
    // Reset form
    document.getElementById('af-deliverable').value = '';
    document.getElementById('af-month').value = '';
    document.getElementById('af-file').value = '';
    document.getElementById('af-url').value = '';
    document.getElementById('af-preview').style.display = 'none';
    document.getElementById('af-preview-pdf').style.display = 'none';
    document.getElementById('af-label-preview').textContent = '';
    document.querySelectorAll('#ps-list .ps-dup-flag').forEach(el => el.remove());
    const _dn = document.getElementById('ps-dup-notice'); if (_dn) { _dn.style.display = 'none'; _dn.textContent = ''; }
    document.getElementById('ps-search').value = '';
    filterPartnerSelector('');
    clearAllPartners();
    st.textContent = '‚úì Submitted for review!'; st.style.color = 'var(--olive)';
    setTimeout(() => { st.textContent = ''; }, 5000);
    setTimeout(loadAssetsTab, 1800);
  } catch(err) { st.textContent = `Error: ${err.message}`; st.style.color = 'var(--sangria)'; }
  finally { btn.disabled = false; }
}

// ‚îÄ‚îÄ Approve / Reject / Remove ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function approveAsset(id, btn) {
  btn.disabled = true; btn.textContent = 'Approving‚Ä¶';
  try {
    for (let attempt = 0; attempt < 3; attempt++) {
      const resData = await ghGetFile('partner-resources.json');
      const json = JSON.parse(resData.content);
      const asset = json.assets.find(a => a.id === id);
      if (!asset) throw new Error('Asset not found');
      asset.status = 'live';
      try {
        await ghPutFile('partner-resources.json', JSON.stringify(json, null, 2), resData.sha, `Approve asset: ${asset.label}`);
        break;
      } catch(e) {
        if (attempt < 2 && e.message && e.message.includes('does not match')) continue;
        throw e;
      }
    }
    setTimeout(loadAssetsTab, 1800);
  } catch(err) { btn.disabled = false; btn.textContent = 'Approve'; alert(`Error: ${err.message}`); }
}

async function rejectAsset(id, btn) {
  if (!confirm('Remove this asset? The image file will also be deleted.')) return;
  btn.disabled = true; btn.textContent = 'Removing‚Ä¶';
  try {
    for (let attempt = 0; attempt < 3; attempt++) {
      const resData = await ghGetFile('partner-resources.json');
      const json = JSON.parse(resData.content);
      const idx = json.assets.findIndex(a => a.id === id);
      if (idx === -1) throw new Error('Asset not found');
      const asset = json.assets[idx];
      try { const img = await ghGetFile(asset.path); await ghDeleteFile(asset.path, img.sha); } catch(e) { /* already gone */ }
      json.assets.splice(idx, 1);
      try {
        await ghPutFile('partner-resources.json', JSON.stringify(json, null, 2), resData.sha, `Remove asset: ${asset.label}`);
        break;
      } catch(e) {
        if (attempt < 2 && e.message && e.message.includes('does not match')) continue;
        throw e;
      }
    }
    setTimeout(loadAssetsTab, 1800);
  } catch(err) { btn.disabled = false; btn.textContent = 'Reject'; alert(`Error: ${err.message}`); }
}

async function removeAsset(id, btn) {
  if (!confirm('Are you sure you want to remove this asset? It will be taken down from all partner portals.')) return;
  await rejectAsset(id, btn);
}

async function removeFromDraft(assetId, partnerKey, btn) {
  btn.disabled = true; btn.textContent = '‚Ä¶';
  try {
    const resData = await ghGetFile('partner-resources.json');
    const json = JSON.parse(resData.content);
    const asset = json.assets.find(a => a.id === assetId);
    if (asset) asset.partnerKeys = (asset.partnerKeys || []).filter(k => k !== partnerKey);
    await ghPutFile('partner-resources.json', JSON.stringify(json, null, 2), resData.sha, `Remove partner from draft asset ${assetId}`);
    setTimeout(loadAssetsTab, 1800);
  } catch(err) { btn.disabled = false; btn.textContent = '√ó'; alert(`Error: ${err.message}`); }
}

function showDraftAddSuggestions(e) {
  const input = e.target;
  const q = input.value.toLowerCase().trim();
  const assetId = input.dataset.assetId;
  const dropdown = document.getElementById('dad-' + assetId);
  if (!q) { dropdown.style.display = 'none'; dropdown.innerHTML = ''; return; }
  const allPartners = (typeof AMPLIFY_DATA !== 'undefined' ? AMPLIFY_DATA.partners : []).filter(p => SIGNED_STAGES_SET.has(p.stage));
  const existingKeys = [...document.querySelectorAll(`[data-chip-asset="${assetId}"]`)].map(el => el.dataset.partnerKey);
  const matches = allPartners.filter(p => p.name.toLowerCase().includes(q) && !existingKeys.includes(p.key)).slice(0, 6);
  if (!matches.length) { dropdown.innerHTML = '<div class="dad-item" style="color:var(--text-light);">No match</div>'; dropdown.style.display = 'block'; return; }
  dropdown.innerHTML = matches.map(p => `<div class="dad-item" onmousedown="addToDraft('${assetId}','${p.key}',event)">${p.name}</div>`).join('');
  dropdown.style.display = 'block';
}

function hideDraftAddSuggestions(assetId) {
  setTimeout(() => {
    const d = document.getElementById('dad-' + assetId);
    if (d) { d.style.display = 'none'; d.innerHTML = ''; }
  }, 200);
}

async function addToDraft(assetId, partnerKey, e) {
  if (e) e.preventDefault();
  const input = document.querySelector(`[data-asset-id="${assetId}"]`);
  if (input) input.value = '';
  hideDraftAddSuggestions(assetId);
  try {
    const resData = await ghGetFile('partner-resources.json');
    const json = JSON.parse(resData.content);
    const asset = json.assets.find(a => a.id === assetId);
    if (asset && !(asset.partnerKeys || []).includes(partnerKey)) {
      asset.partnerKeys = [...(asset.partnerKeys || []), partnerKey];
    }
    await ghPutFile('partner-resources.json', JSON.stringify(json, null, 2), resData.sha, `Add partner to draft asset ${assetId}`);
    setTimeout(loadAssetsTab, 1800);
  } catch(err) { alert(`Error: ${err.message}`); }
}

// ‚îÄ‚îÄ Load & render assets tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAssetsTab() {
  const banner = document.getElementById('assets-no-token-banner');
  banner.style.display = ghToken() ? 'none' : '';
  if (!ghToken()) return;
  try {
    const resData = await ghGetFile('partner-resources.json');
    const json = JSON.parse(resData.content);
    const assets = json.assets || [];
    const draft = assets.filter(a => a.status === 'draft');
    const live  = assets.filter(a => a.status === 'live');
    const badge = document.getElementById('pending-badge');
    badge.textContent = draft.length; badge.style.display = draft.length ? '' : 'none';
    const pNames = {};
    (typeof AMPLIFY_DATA !== 'undefined' ? AMPLIFY_DATA.partners : []).forEach(p => { pNames[p.key] = p.name; });
    const base = window.location.origin + window.location.pathname.replace(/index\.html$/, '').replace(/\/$/, '');
    function assetCardHtml(a, isDraft) {
      const chips = isDraft
        ? (a.partnerKeys || []).map(k =>
            `<span class="partner-chip" data-chip-asset="${a.id}" data-partner-key="${k}">${pNames[k] || k} <button class="btn-unlink" onclick="removeFromDraft('${a.id}','${k}',this)">√ó</button></span>`
          ).join('')
        : (a.partnerKeys || []).map(k => pNames[k] || k).join(', ');
      const isPdf = a.path && a.path.toLowerCase().endsWith('.pdf');
      const uploadDate = a.uploadedAt ? new Date(a.uploadedAt).toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'}) : '';

      if (isDraft) {
        const isUrlAsset = a.assetType === 'url' || (!a.path && a.url);
        return `<div class="review-card">
          <div class="review-card-two-col">
            <div>
              ${isUrlAsset
                ? `<a href="${a.url}" target="_blank" rel="noopener" class="review-card-pdf"><span style="font-size:32px;">üîó</span><span style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${a.url}</span></a>`
                : isPdf
                  ? `<a href="${base}/${a.path}" target="_blank" rel="noopener" class="review-card-pdf"><span style="font-size:40px;">üìÑ</span> View PDF</a>`
                  : `<img class="review-card-img" src="${base}/${a.path}" alt="${a.label}" onerror="this.outerHTML='<div class=review-card-img style=display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;color:var(--stone);font-size:12px;><span style=font-size:28px;>üïê</span>Image still uploading ‚Äî refresh in a moment</div>'">`}
            </div>
            <div>
              <div class="review-card-deliv">${a.deliverable}</div>
              <div class="review-card-label">${a.label}</div>
              <div class="review-card-section-label">Partners</div>
              <div style="margin-bottom:6px;">${chips || '<em style="color:var(--text-light);font-size:12px;">None selected</em>'}</div>
              <div class="draft-add-wrap">
                <input type="text" class="draft-add-input" placeholder="+ Add partner‚Ä¶" data-asset-id="${a.id}" oninput="showDraftAddSuggestions(event)" onblur="hideDraftAddSuggestions('${a.id}')" autocomplete="off">
                <div class="draft-add-dropdown" id="dad-${a.id}"></div>
              </div>
              ${uploadDate ? `<div style="font-size:12px;color:var(--text-light);margin-top:12px;">Uploaded ${uploadDate}</div>` : ''}
              <div class="review-card-actions">
                <button class="btn-approve" onclick="approveAsset('${a.id}',this)">Approve</button>
                <button class="btn-reject"  onclick="rejectAsset('${a.id}',this)">Reject</button>
              </div>
            </div>
          </div>
        </div>`;
      }

      const isUrlAsset2 = a.assetType === 'url' || (!a.path && a.url);
      return `<div class="asset-card">
        ${isUrlAsset2
          ? `<a href="${a.url}" target="_blank" rel="noopener" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:150px;background:var(--dark-sand);font-size:28px;text-decoration:none;gap:6px;color:var(--text-light);font-size:12px;">üîó<span style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;">${a.url}</span></a>`
          : isPdf
            ? `<a href="${base}/${a.path}" target="_blank" rel="noopener" style="display:flex;align-items:center;justify-content:center;height:150px;background:var(--dark-sand);font-size:42px;text-decoration:none;">üìÑ</a>`
            : `<img class="asset-card-thumb" src="${base}/${a.path}" alt="${a.label}" onerror="this.style.background='var(--dark-sand)'">`}
        <div class="asset-card-body">
          <div class="asset-card-deliv">${a.deliverable}</div>
          <div class="asset-card-label">${a.label}</div>
          <div class="asset-card-meta">
            ${chips ? `<strong>Partners:</strong> ${chips}<br>` : ''}
            ${a.note ? `${a.note}<br>` : ''}
            ${uploadDate}
          </div>
          <div class="asset-card-actions">
            <button class="btn-remove" onclick="removeAsset('${a.id}',this)">Remove</button>
          </div>
        </div>
      </div>`;
    }
    document.getElementById('pending-cards').innerHTML = draft.length
      ? draft.map(a => assetCardHtml(a, true)).join('')
      : '<p style="color:var(--text-light);font-size:13px;">No assets pending review.</p>';
    document.getElementById('live-cards').innerHTML = live.length
      ? buildLiveGroups(live, pNames, base)
      : '<p style="color:var(--text-light);font-size:13px;">No live assets yet.</p>';
  } catch(err) {
    console.error('Assets tab error:', err);
    document.getElementById('pending-cards').innerHTML = `<p style="color:var(--sangria);font-size:13px;">Could not load assets: ${err.message}</p>`;
  }
}

// ‚îÄ‚îÄ Live assets grouped by month ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _MONTH_ORDER = {January:1,February:2,March:3,April:4,May:5,June:6,July:7,August:8,September:9,October:10,November:11,December:12};
const _MONTHS_LIST = Object.keys(_MONTH_ORDER);

// Find the real month name anywhere in a label string (case-insensitive)
function _labelMonth(label) {
  if (!label) return null;
  const lower = label.toLowerCase();
  return _MONTHS_LIST.find(m => lower.includes(m.toLowerCase())) || null;
}

// Rewrite label so it starts cleanly with the month, removing any prefix like "Mid "
function _normalizeLabel(label) {
  if (!label) return label;
  const month = _labelMonth(label);
  if (!month) return label;
  const idx = label.toLowerCase().indexOf(month.toLowerCase());
  const rest = label.substring(idx + month.length).trim();
  return rest ? `${month} ${rest}` : month;
}

function buildLiveGroups(live, pNames, base) {
  // Group by month, then by deliverable
  const byMonth = {};
  live.forEach(a => {
    const month = _labelMonth(a.label) || 'Other';
    const deliv = a.deliverable || 'Other';
    if (!byMonth[month]) byMonth[month] = {};
    if (!byMonth[month][deliv]) byMonth[month][deliv] = [];
    byMonth[month][deliv].push(a);
  });
  const sortedMonths = Object.keys(byMonth).sort((a, b) => (_MONTH_ORDER[a] || 99) - (_MONTH_ORDER[b] || 99));

  return sortedMonths.map((month, mIdx) => {
    const byDeliv = byMonth[month];
    const sortedDelivs = Object.keys(byDeliv).sort();
    const totalCount = sortedDelivs.reduce((sum, d) => sum + byDeliv[d].length, 0);

    const subgroups = sortedDelivs.map(deliv => {
      const assets = byDeliv[deliv];
      const rows = assets.map(a => {
        const isUrl = a.assetType === 'url' || (!a.path && a.url);
        const isPdf = !isUrl && a.path && a.path.toLowerCase().endsWith('.pdf');
        const partners = (a.partnerKeys || []).map(k => pNames[k] || k).join(', ');
        const displayLabel = _normalizeLabel(a.label) || a.deliverable;
        const preview = isUrl
          ? `<a href="${a.url}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;font-size:12px;color:var(--olive);font-weight:600;text-decoration:none;white-space:nowrap;">üîó View</a>`
          : isPdf
          ? `<a href="${base}/${a.path}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;font-size:12px;color:var(--olive);font-weight:600;text-decoration:none;">üìÑ PDF</a>`
          : `<a href="${base}/${a.path}" target="_blank" rel="noopener"><img src="${base}/${a.path}" style="width:56px;height:40px;object-fit:cover;border-radius:5px;border:1px solid var(--border);display:block;" onerror="this.style.display='none'"></a>`;
        return `<div class="live-row">
          <div class="live-row-preview">${preview}</div>
          <div class="live-row-info">
            <div class="live-row-deliv">${displayLabel}</div>
            <div class="live-row-partners">${partners || '‚Äî'}</div>
          </div>
        </div>`;
      }).join('');
      return `<div class="live-subgroup open">
        <div class="live-subgroup-header" onclick="this.parentElement.classList.toggle('open')">
          <span class="live-subgroup-title">${deliv}</span>
          <span class="live-subgroup-count">${assets.length} asset${assets.length !== 1 ? 's' : ''}</span>
          <span class="live-subgroup-chevron">‚ñº</span>
        </div>
        <div class="live-subgroup-body">${rows}</div>
      </div>`;
    }).join('');

    return `<div class="live-group${mIdx === 0 ? ' open' : ''}">
      <div class="live-group-header" onclick="this.parentElement.classList.toggle('open')">
        <span class="live-group-title">${month}</span>
        <span class="live-group-count">${totalCount} asset${totalCount !== 1 ? 's' : ''}</span>
        <span class="live-group-chevron">‚ñº</span>
      </div>
      <div class="live-group-body">${subgroups}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Navigate to a partner on the search tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function navigateToPartner(name) {
  const searchNavEl = document.querySelector('.nav-tab[onclick*="\'search\'"]');
  showTab('search', searchNavEl);
  document.getElementById('partnerSearch').value = name;
  _runFilter();
  document.getElementById('tab-search').scrollIntoView({ behavior: 'smooth', block: 'start' });
  // Auto-expand the partner row once the filter has rendered
  setTimeout(() => {
    const firstRow = document.querySelector('#partnerSearchTbody tr');
    if (firstRow) firstRow.click();
  }, 50);
}

// ‚îÄ‚îÄ Accordion toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleSection(id) {
  document.getElementById('acc-hdr-' + id).classList.toggle('closed');
  document.getElementById('acc-body-' + id).classList.toggle('closed');
}

// ‚îÄ‚îÄ Colors (Fora brand palette) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const OLIVE  = '#77742a';  // Fora Olive
const INDIGO = '#333880';  // Fora Indigo
const SANG   = '#870d13';  // Fora Sangria
const STONE  = '#827363';  // Fora Stone
const DSHELL = '#bdb1a4';  // Fora Dark Shell
const DSTONE = '#63574a';  // Fora Dark Stone
const BLACK  = '#131313';  // Fora Black Sand
// Semantic aliases
const GOLD   = OLIVE;
const NAVY   = BLACK;
const GREEN  = OLIVE;
const AMBER  = INDIGO;
const RED    = SANG;
const NAVY2  = '#1e1e1e';
const GOLD2  = '#e5dbd0';  // Fora Shell
const TEAL   = INDIGO;
const PURPLE = STONE;

Chart.defaults.font.family = "'Blanco', -apple-system, BlinkMacSystemFont, sans-serif";
Chart.defaults.font.size   = 12;
Chart.defaults.color       = '#827363';

// ‚îÄ‚îÄ Formatters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt  = n => '$' + Math.round(n).toLocaleString();
const fmtK = n => '$' + (Math.round(n/1000)) + 'K';
const pct  = (a, b) => b ? Math.round(a/b*100) + '%' : '0%';

function stageBadge(stage) {
  const cls = {
    'Tier 1': 'badge-gold', 'Tier 2': 'badge-teal',
    'Brand Spotlight': 'badge-navy', 'New Opening': 'badge-amber',
    'Marketing Complete': 'badge-green',
    'Needs Invoice': 'badge-red', 'In Discussion': 'badge-amber',
    'Final Follow Up': 'badge-amber', 'Needs Contact': 'badge-gray',
    'Needs Review': 'badge-gray', 'Declined': 'badge-red',
    'Do Not Invite': 'badge-gray',
  }[stage] || 'badge-gray';
  return `<span class="badge ${cls}">${stage}</span>`;
}

function invoiceBadge(status) {
  if (!status) return '<span class="badge badge-gray">‚Äî</span>';
  const cls = {
    'Paid': 'badge-green', 'Outstanding': 'badge-red',
    'To Invoice': 'badge-amber', 'Waiting for billing details': 'badge-amber',
    'In Kind Sponsorship': 'badge-navy', 'Invoice held': 'badge-gray',
  }[status] || 'badge-gray';
  return `<span class="badge ${cls}">${status}</span>`;
}

// ‚îÄ‚îÄ Leaderboard builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildLeaderboard(id, data) {
  const max = data[0] ? data[0][1] : 1;
  const el = document.getElementById(id);
  data.forEach(([label, count], i) => {
    el.innerHTML += `
      <div class="lb-item">
        <div class="lb-rank">${i+1}</div>
        <div class="lb-label">${label}</div>
        <div class="lb-bar-wrap"><div class="lb-bar" style="width:${(count/max)*100}%"></div></div>
        <div class="lb-count">${count}</div>
      </div>`;
  });
}

// ‚îÄ‚îÄ Main data loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
  if (typeof AMPLIFY_DATA === 'undefined') {
    document.getElementById('headerSubtitle').textContent = '‚ö† data.js not found ‚Äî run python3 update.py';
    return;
  }
  const D = AMPLIFY_DATA;

  // Header
  document.getElementById('headerSubtitle').textContent =
    `Data refreshed ${D.lastUpdated} ¬∑ ${D.signedCount} signed partners`;
  document.getElementById('weekBadge').textContent = `Updated ${D.lastUpdated}`;
  document.getElementById('overviewSubtitle').textContent =
    `Full program status as of ${D.lastUpdated}.`;

  // ‚îÄ‚îÄ Overview KPIs ‚îÄ‚îÄ
  document.getElementById('kpiSignedCount').textContent    = D.signedCount;
  document.getElementById('kpiTotalSigned').textContent    = fmt(D.totalSigned);
  document.getElementById('kpiPaid').textContent           = fmt(D.paid);
  document.getElementById('kpiPaidSub').textContent        = pct(D.paid, D.totalSigned) + ' of total signed';
  const paidPct = D.totalSigned > 0 ? D.paid / D.totalSigned : 0;
  const trackEl = document.getElementById('paidTrackBadge');
  if (paidPct >= 0.5) { trackEl.className = 'kpi-delta up';   trackEl.textContent = '‚ñ≤ on track'; }
  else                 { trackEl.className = 'kpi-delta warn'; trackEl.textContent = '‚ñº behind pace ‚Äî ' + Math.round(paidPct * 100) + '% collected'; }
  document.getElementById('kpiTotalPipeline').textContent  = fmt(D.totalPipeline);
  document.getElementById('kpiInDiscussion').textContent   = fmt(D.inDiscussion);
  document.getElementById('kpiInDiscussionSub').textContent = `${D.inDiscussionCount} partners in active conversation`;
  document.getElementById('kpiNeedsInvoice').textContent   = fmt(D.needsInvoice);
  document.getElementById('kpiNeedsInvoiceSub').textContent = `${D.needsInvoiceCount} signed partners not yet invoiced`;
  document.getElementById('kpiFinalFollowUp').textContent  = fmt(D.finalFollowUp);
  document.getElementById('kpiFinalFollowUpSub').textContent = `${D.finalFollowUpCount} partners ¬∑ last touch before decision`;
  document.getElementById('kpiMarketingComplete').textContent = fmt(D.marketingComplete);

  // ‚îÄ‚îÄ Revenue by Package chart ‚îÄ‚îÄ
  const stageLabels = Object.keys(D.byStage);
  const stageColors = [OLIVE, INDIGO, SANG, STONE, DSHELL, BLACK];
  new Chart(document.getElementById('revenueChart'), {
    type: 'bar',
    data: {
      labels: stageLabels,
      datasets: [{ label: 'Revenue', data: Object.values(D.byStage), backgroundColor: stageColors, borderRadius: 6, borderSkipped: false }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ' ' + fmt(ctx.raw) } } },
      scales: { y: { ticks: { callback: v => fmtK(v) }, grid: { color: '#f0eeea' } }, x: { grid: { display: false } } }
    }
  });

  // ‚îÄ‚îÄ Invoice donut ‚îÄ‚îÄ
  new Chart(document.getElementById('invoiceChart'), {
    type: 'doughnut',
    data: {
      labels: ['Paid', 'Outstanding', 'Needs Invoice', 'Waiting on Billing'],
      datasets: [{ data: [D.paid, D.outstanding, D.needsInvoice, D.waitingBilling], backgroundColor: [OLIVE, SANG, DSHELL, INDIGO], borderWidth: 2, borderColor: '#fff' }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '65%',
      plugins: {
        legend: { position: 'bottom', labels: { padding: 16, boxWidth: 12 } },
        tooltip: { callbacks: { label: ctx => ' ' + fmt(ctx.raw) } }
      }
    }
  });

  // ‚îÄ‚îÄ Tier donut ‚îÄ‚îÄ
  new Chart(document.getElementById('tierChart'), {
    type: 'doughnut',
    data: {
      labels: Object.keys(D.countByStage),
      datasets: [{ data: Object.values(D.countByStage), backgroundColor: [OLIVE, INDIGO, SANG, STONE, DSHELL], borderWidth: 2, borderColor: '#fff' }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '60%',
      plugins: { legend: { position: 'bottom', labels: { padding: 12, boxWidth: 12 } } }
    }
  });

  // ‚îÄ‚îÄ Quarter chart ‚îÄ‚îÄ
  const qLabels = ['Q1', 'Q2', 'Q3', 'Q4', 'August', 'TBD'].filter(q => (D.quarters[q] || 0) > 0);
  const qData   = qLabels.map(q => D.quarters[q] || 0);
  new Chart(document.getElementById('quarterChart'), {
    type: 'bar',
    data: { labels: qLabels, datasets: [{ data: qData, backgroundColor: [OLIVE, INDIGO, SANG, STONE, DSHELL, DSTONE], borderRadius: 6, borderSkipped: false }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ' ' + ctx.raw + ' partners' } } },
      scales: { y: { grid: { color: '#f0eeea' } }, x: { grid: { display: false } } }
    }
  });

  // ‚îÄ‚îÄ Features chart ‚îÄ‚îÄ
  const fLabels = Object.keys(D.features);
  const fData   = Object.values(D.features);
  new Chart(document.getElementById('featuresChart'), {
    type: 'bar',
    data: { labels: fLabels, datasets: [{ data: fData, backgroundColor: [OLIVE, INDIGO, SANG, STONE, DSHELL, DSTONE, BLACK], borderRadius: 6, borderSkipped: false }] },
    options: {
      responsive: true, maintainAspectRatio: false, indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: { x: { grid: { color: '#f0eeea' } }, y: { grid: { display: false } } }
    }
  });

  // Pipeline overview
  const funnelColors = {
    '5014': OLIVE,  '5015': DSHELL, '5016': BLACK,  '5017': STONE, '5007': INDIGO,
    '5011': SANG,   '5004': INDIGO, '5001': STONE,
    '5013': DSHELL, '5010': '#c0bcb3', '5008': SANG, '5009': '#888',
  };
  const signedKeys   = new Set(['5014','5015','5016','5017','5007']);
  const pipelineKeys = new Set(['5011','5004','5001']);

  (function buildPipelineOverview() {
    const fl = document.getElementById('funnelList');
    const signed   = D.funnel.filter(f => signedKeys.has(f.stageKey));
    const pipeline = D.funnel.filter(f => pipelineKeys.has(f.stageKey));
    const other    = D.funnel.filter(f => !signedKeys.has(f.stageKey) && !pipelineKeys.has(f.stageKey));
    const total    = D.funnel.reduce((s, f) => s + f.count, 0);
    const sCnt     = signed.reduce((s, f) => s + f.count, 0);
    const pCnt     = pipeline.reduce((s, f) => s + f.count, 0);
    const oCnt     = other.reduce((s, f) => s + f.count, 0);
    const sp = total ? (sCnt / total * 100) : 0;
    const pp = total ? (pCnt / total * 100) : 0;
    const op = total ? (oCnt / total * 100) : 0;

    const rowHtml = (f) => `
      <div class="pl-row">
        <div class="pl-dot" style="background:${funnelColors[f.stageKey]||'#aaa'};"></div>
        <div class="pl-name">${f.label.replace('Signed \u2014 ','')}</div>
        <div class="pl-count">${f.count}</div>
        <div class="pl-val">${f.value ? fmt(f.value) : '\u2014'}</div>
      </div>`;

    const otherSection = other.length ? `
      <div class="pipeline-col-hdr mt">Other Stages</div>
      ${other.map(f => `
        <div class="pl-row">
          <div class="pl-dot" style="background:${funnelColors[f.stageKey]||'#aaa'};"></div>
          <div class="pl-name">${f.label}</div>
          <div class="pl-count">${f.count}</div>
          <div class="pl-val">\u2014</div>
        </div>`).join('')}` : '';

    fl.innerHTML = `
      <div class="pipeline-seg-bar">
        <div class="pipeline-seg" style="width:${sp}%;background:${OLIVE};"></div>
        <div class="pipeline-seg" style="width:${pp}%;background:${INDIGO};"></div>
        <div class="pipeline-seg" style="width:${op}%;background:#c0bcb3;"></div>
      </div>
      <div class="pipeline-seg-labels">
        <span class="pipeline-seg-label"><span class="pipeline-seg-dot" style="background:${OLIVE};"></span>Signed: <strong style="margin-left:3px;">${sCnt}</strong>&nbsp;(${Math.round(sp)}%)</span>
        <span class="pipeline-seg-label"><span class="pipeline-seg-dot" style="background:${INDIGO};"></span>In Pipeline: <strong style="margin-left:3px;">${pCnt}</strong>&nbsp;(${Math.round(pp)}%)</span>
        <span class="pipeline-seg-label"><span class="pipeline-seg-dot" style="background:#c0bcb3;"></span>Other Stages: <strong style="margin-left:3px;">${oCnt}</strong></span>
      </div>
      <div class="pipeline-cols">
        <div>
          <div class="pipeline-col-hdr">Signed Partners</div>
          ${signed.map(rowHtml).join('')}
        </div>
        <div>
          <div class="pipeline-col-hdr">In Pipeline</div>
          ${pipeline.map(f => `
            <div class="pl-row">
              <div class="pl-dot" style="background:${funnelColors[f.stageKey]||'#aaa'};"></div>
              <div class="pl-name">${f.label}</div>
              <div class="pl-count">${f.count}</div>
              <div class="pl-val">${f.value ? fmt(f.value) : '\u2014'}</div>
            </div>`).join('')}
          ${otherSection}
        </div>
      </div>`;
  })();

  // Signed over time chart
  if (D.signedOverTime && D.signedOverTime.length > 0) {
    const sotLabels   = D.signedOverTime.map(d => d.month);
    const sotCumCount = D.signedOverTime.map(d => d.cumCount);
    const sotCumValue = D.signedOverTime.map(d => d.cumValue);
    new Chart(document.getElementById('signedOverTimeChart'), {
      type: 'line',
      data: {
        labels: sotLabels,
        datasets: [
          {
            label: 'Partners Signed (cumulative)',
            data: sotCumCount,
            borderColor: OLIVE,
            backgroundColor: 'rgba(119,116,42,0.08)',
            borderWidth: 2.5,
            pointRadius: 3,
            pointHoverRadius: 5,
            fill: true,
            tension: 0.35,
            yAxisID: 'yCount',
          },
          {
            label: 'Value Signed (cumulative)',
            data: sotCumValue,
            borderColor: INDIGO,
            backgroundColor: 'rgba(51,56,128,0.06)',
            borderWidth: 2,
            pointRadius: 2,
            pointHoverRadius: 4,
            fill: true,
            tension: 0.35,
            yAxisID: 'yValue',
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'bottom', labels: { padding: 16, boxWidth: 12 } },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                if (ctx.datasetIndex === 1) return ' ' + fmt(ctx.raw);
                return ' ' + ctx.raw + ' partners';
              }
            }
          }
        },
        scales: {
          yCount: {
            type: 'linear', position: 'left',
            grid: { color: '#f0eeea' },
            ticks: { stepSize: 25, color: OLIVE },
          },
          yValue: {
            type: 'linear', position: 'right',
            grid: { drawOnChartArea: false },
            ticks: {
              color: INDIGO,
              callback: (v) => '$' + (v >= 1000 ? Math.round(v/1000) + 'K' : v)
            }
          },
          x: { grid: { display: false }, ticks: { maxRotation: 45 } }
        }
      }
    });
  } else {
    document.getElementById('signedOverTimeChart').parentElement.innerHTML =
      '<p style="color:var(--text-light);font-size:13px;padding:20px 0;">Date data will appear after the next dashboard refresh.</p>';
  }

  // ‚îÄ‚îÄ Invoices tab ‚îÄ‚îÄ
  document.getElementById('invPaid').textContent          = fmt(D.paid);
  document.getElementById('invPaidSub').textContent       = pct(D.paid, D.totalSigned) + ' of total signed value';
  document.getElementById('invOutstanding').textContent   = fmt(D.outstanding);
  document.getElementById('invWaiting').textContent       = fmt(D.waitingBilling);
  document.getElementById('invWaitingSub').textContent    = 'Signed partners pending billing info';
  document.getElementById('invNeedsInvoice').textContent  = fmt(D.needsInvoice);
  document.getElementById('invNeedsInvoiceSub').textContent = `${D.needsInvoiceCount} signed partners`;
  document.getElementById('invoiceSubtitle').textContent  =
    `${fmt(D.needsInvoice)} in signed partners not yet invoiced. ${fmt(D.outstanding)} outstanding.`;

  // Needs invoice table
  const needsInvoicePartners = (D.partners || [])
    .filter(p => p.stageKey === '5011' || p.invoiceStatus === 'To Invoice')
    .sort((a,b) => b.price - a.price);
  const invTbody = document.getElementById('needsInvoiceTbody');
  if (needsInvoicePartners.length === 0) {
    invTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-light);padding:20px;">All signed partners have been invoiced ‚Äî great work!</td></tr>';
  } else {
    needsInvoicePartners.forEach(p => {
      const priority = p.price >= 8000 ? '<span class="badge badge-red">High</span>' :
                       p.price >= 4000 ? '<span class="badge badge-amber">Medium</span>' :
                       '<span class="badge badge-gray">Standard</span>';
      invTbody.innerHTML += `
        <tr>
          <td><a href="#" onclick="navigateToPartner(${JSON.stringify(p.name)}); return false;" style="color:var(--text);font-weight:600;text-decoration:none;">${p.name}</a></td>
          <td>${stageBadge(p.stage)}</td>
          <td class="amount">${p.price ? fmt(p.price) : '‚Äî'}</td>
          <td>${p.country || '‚Äî'}</td>
          <td>${priority}</td>
          <td><a href="${p.streakUrl}" target="_blank" style="color:var(--gold);font-weight:600;text-decoration:none;">View ‚Üí</a></td>
        </tr>`;
    });
  }

  // ‚îÄ‚îÄ Partners tab ‚îÄ‚îÄ
  buildLeaderboard('countryLeaderboard', D.topCountries);
  buildLeaderboard('groupLeaderboard',   D.topGroups);
  buildLeaderboard('brandLeaderboard',   D.topBrands);

  new Chart(document.getElementById('partnerTypeChart'), {
    type: 'doughnut',
    data: {
      labels: Object.keys(D.countByStage),
      datasets: [{ data: Object.values(D.countByStage), backgroundColor: [OLIVE, INDIGO, SANG, STONE, DSHELL], borderWidth: 2, borderColor: '#fff' }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '60%',
      plugins: { legend: { position: 'bottom', labels: { padding: 16, boxWidth: 12 } } }
    }
  });

  new Chart(document.getElementById('featuresChart2'), {
    type: 'bar',
    data: { labels: fLabels, datasets: [{ label: 'Partners booked', data: fData, backgroundColor: [OLIVE, INDIGO, SANG, STONE, DSHELL, DSTONE, BLACK], borderRadius: 6, borderSkipped: false }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { grid: { color: '#f0eeea' } }, x: { grid: { display: false } } }
    }
  });

  // ‚îÄ‚îÄ New This Week banner ‚îÄ‚îÄ
  const ntw = D.newThisWeek || [];
  if (ntw.length > 0) {
    const banner = document.getElementById('newThisWeekBanner');
    banner.style.display = 'flex';
    banner.innerHTML = `
      <div class="new-banner-dot"></div>
      <div style="flex:1;">
        <div class="new-banner-label">New this week ‚Äî ${ntw.length} signed partner${ntw.length !== 1 ? 's' : ''}</div>
        <div class="new-banner-chips">
          ${ntw.map(p => `
            <span class="new-chip" onclick="navigateToPartner(${JSON.stringify(p.name)})" title="Click to view in Partner Search">
              <span class="new-chip-name">${p.name}</span>
              <span class="new-chip-stage">${p.stage}${p.price ? ' ¬∑ ' + fmt(p.price) : ''}</span>
            </span>`).join('')}
        </div>
      </div>`;
  }

  // ‚îÄ‚îÄ Deliverable Calendar ‚îÄ‚îÄ
  buildDeliverableCalendar(D);

  // ‚îÄ‚îÄ Partner Search ‚îÄ‚îÄ
  window._allPartners = D.partners || [];
  filterPartners();

  // ‚îÄ‚îÄ Scenario Planner ‚îÄ‚îÄ
  initPlanner(D);

  // ‚îÄ‚îÄ Next Steps ‚îÄ‚îÄ
  buildNextSteps(D);

  // ‚îÄ‚îÄ Team Updates ‚îÄ‚îÄ
  buildTeamUpdates(D);
}

// ‚îÄ‚îÄ Deliverable Calendar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildDeliverableCalendar(D) {
  const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const MONTH_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const DELIV_TYPES = ['Collection','Forum','Newsletter','Advisor Assets','Webinar','Social Media','Journal Article'];

  // Determine current month for past/future colouring
  const now = new Date();
  const nowIdx = now.getFullYear() * 12 + now.getMonth();

  // Build cal[monthIdx][type] = {planned: N, completed: N}
  const cal = {};
  const signedKeys2 = new Set(['5014','5015','5016','5017','5007']);
  (D.partners || [])
    .filter(p => signedKeys2.has(p.stageKey))
    .forEach(p => {
      (p.features || []).forEach(f => {
        if (!f.timing || !f.timing.trim()) return;
        // Split comma-separated entries (e.g. "March - Completed, September - Planned")
        // so each part is assessed independently for its own month and status.
        const parts = f.timing.split(',').map(s => s.trim()).filter(Boolean);
        parts.forEach(part => {
          const status = _delivStatus(part);
          if (status === 'none') return;
          const label = _scheduledLabel(part); // e.g., "March"
          const lc = label.toLowerCase();
          let mIdx = -1;
          for (let i = 0; i < MONTH_NAMES.length; i++) {
            if (lc === MONTH_NAMES[i].toLowerCase() || lc === MONTH_SHORT[i].toLowerCase()) {
              mIdx = i; break;
            }
          }
          if (mIdx < 0) return;
          if (!cal[mIdx]) cal[mIdx] = {};
          if (!cal[mIdx][f.name]) cal[mIdx][f.name] = { planned: 0, completed: 0 };
          if (status === 'completed') cal[mIdx][f.name].completed++;
          else cal[mIdx][f.name].planned++;
        });
      });
    });

  const monthIdxs = Object.keys(cal).map(Number).sort((a, b) => a - b);
  if (!monthIdxs.length) return;

  // Compute total deliverables across all months for the subtitle
  let totalDeliv = 0;
  monthIdxs.forEach(mi => Object.values(cal[mi]).forEach(v => { totalDeliv += v.planned + v.completed; }));
  document.getElementById('calendarMeta').textContent =
    `${totalDeliv} deliverables across ${monthIdxs.length} months for signed partners.`;

  const grid = document.getElementById('calGrid');
  monthIdxs.forEach(mi => {
    const isPast = (mi < now.getMonth()) && now.getFullYear() === 2026;
    const types  = DELIV_TYPES.filter(t => cal[mi][t]);
    const total  = types.reduce((s, t) => s + cal[mi][t].planned + cal[mi][t].completed, 0);

    const rowsHtml = types.map(t => {
      const { planned, completed } = cal[mi][t];
      const countHtml = [
        completed ? `<span class="cal-done" title="${completed} completed">‚úì${completed}</span>` : '',
        planned   ? `<span class="cal-planned" title="${planned} upcoming">${planned}</span>` : '',
      ].filter(Boolean).join('<span style="color:var(--border);margin:0 2px;">¬∑</span>');
      return `<div class="cal-row"><span class="cal-type">${t}</span><span class="cal-counts">${countHtml}</span></div>`;
    }).join('');

    const card = document.createElement('div');
    card.className = 'cal-month' + (isPast ? ' past' : '');
    card.innerHTML = `
      <div style="display:flex;align-items:baseline;justify-content:space-between;margin-bottom:10px;">
        <div class="cal-month-name">${MONTH_NAMES[mi]}</div>
        <div class="cal-total">${total}</div>
      </div>
      ${rowsHtml}`;
    grid.appendChild(card);
  });
}

// ‚îÄ‚îÄ Keyboard shortcut: / ‚Üí jump to Partner Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', (e) => {
  if (e.key === '/' && !['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) {
    e.preventDefault();
    const searchNavEl = document.querySelector('.nav-tab[onclick*="\'search\'"]');
    showTab('search', searchNavEl);
    const inp = document.getElementById('partnerSearch');
    inp.focus();
    inp.select();
  }
});

// ‚îÄ‚îÄ Partner Search (debounced + lazy detail rendering) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _searchTimer = null;
let _sortCol = '';
let _sortDir = 'asc';
const _renderedDetails = new Set();

const STAGE_ORDER = {'5014':0,'5015':1,'5016':2,'5017':3,'5007':4,'5011':5,'5004':6,'5001':7};

function sortPartners(col) {
  if (_sortCol === col) {
    _sortDir = _sortDir === 'asc' ? 'desc' : 'asc';
  } else {
    _sortCol = col;
    _sortDir = (col === 'price' || col === 'progress') ? 'desc' : 'asc';
  }
  // Update header highlight + icon
  document.querySelectorAll('thead th.sortable').forEach(th => {
    th.classList.remove('sort-active');
    const icon = th.querySelector('.sort-icon');
    if (icon) icon.textContent = '‚Üï';
  });
  const active = document.getElementById('sth-' + col);
  if (active) {
    active.classList.add('sort-active');
    const icon = active.querySelector('.sort-icon');
    if (icon) icon.textContent = _sortDir === 'asc' ? '‚Üë' : '‚Üì';
  }
  _runFilter();
}

function filterPartners() {
  clearTimeout(_searchTimer);
  _searchTimer = setTimeout(_runFilter, 180);
}

function _runFilter() {
  const query   = document.getElementById('partnerSearch').value.toLowerCase().trim();
  const stage   = document.getElementById('stageFilter').value;
  const invoice = document.getElementById('invoiceFilter').value;
  const quarter = document.getElementById('quarterFilter').value;

  let results = window._allPartners || [];
  if (query)   results = results.filter(p =>
    p.name.toLowerCase().includes(query) ||
    (p.brand || '').toLowerCase().includes(query) ||
    (p.group || '').toLowerCase().includes(query) ||
    (p.country || '').toLowerCase().includes(query)
  );
  if (stage)   results = results.filter(p => p.stage === stage);
  if (invoice) results = results.filter(p => p.invoiceStatus === invoice);
  if (quarter) {
    if (quarter === 'TBD') results = results.filter(p => !p.quarters || p.quarters.length === 0);
    else results = results.filter(p => (p.quarters || []).includes(quarter));
  }

  // Apply sort
  if (_sortCol) {
    results = [...results].sort((a, b) => {
      let av, bv;
      if (_sortCol === 'price') {
        av = a.price || 0; bv = b.price || 0;
      } else if (_sortCol === 'stageKey') {
        av = STAGE_ORDER[a.stageKey] ?? 99; bv = STAGE_ORDER[b.stageKey] ?? 99;
      } else if (_sortCol === 'quarters') {
        const aq = (a.quarters || []).slice().sort(); const bq = (b.quarters || []).slice().sort();
        av = aq[0] || 'ZZZ'; bv = bq[0] || 'ZZZ';
      } else if (_sortCol === 'progress') {
        const ap = _delivProgressSimple(a); const bp = _delivProgressSimple(b);
        av = ap && ap.total > 0 ? ap.completed / ap.total : -1;
        bv = bp && bp.total > 0 ? bp.completed / bp.total : -1;
      } else {
        av = (a[_sortCol] || '').toLowerCase(); bv = (b[_sortCol] || '').toLowerCase();
      }
      if (av < bv) return _sortDir === 'asc' ? -1 : 1;
      if (av > bv) return _sortDir === 'asc' ? 1 : -1;
      return 0;
    });
  }

  document.getElementById('searchResultCount').textContent =
    `${results.length} partner${results.length !== 1 ? 's' : ''} found`;

  const tbody = document.getElementById('partnerSearchTbody');
  const frag  = document.createDocumentFragment();
  _renderedDetails.clear();
  tbody.innerHTML = '';

  if (results.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="8" style="text-align:center;color:var(--text-light);padding:24px;">No partners match your search.</td>';
    tbody.appendChild(tr);
    return;
  }

  results.slice(0, 100).forEach(p => {
    const qStr = (p.quarters || []).length > 0
      ? (p.quarters || []).join(', ')
      : '<span style="color:var(--text-light)">TBD</span>';

    // Progress column
    const prog = _delivProgressSimple(p);
    let progHtml;
    if (prog && prog.total > 0) {
      const pct = Math.round(prog.completed / prog.total * 100);
      const color = prog.completed === prog.total ? 'var(--olive,#77742A)' : (prog.completed > 0 ? '#c9a800' : '#ccc');
      progHtml = `<span class="prog-cell"><strong>${prog.completed}/${prog.total}</strong><span class="prog-bar-wrap"><span class="prog-bar-fill" style="width:${pct}%;background:${color};"></span></span></span>`;
    } else {
      const featStr = (p.features || []).map(f => typeof f === 'object' ? f.name : f).slice(0, 3).join(', ') +
        ((p.features || []).length > 3 ? ' +' + ((p.features || []).length - 3) : '');
      progHtml = `<span style="font-size:12px;color:var(--text-light);">${featStr || '‚Äî'}</span>`;
    }

    // Main row ‚Äî built via innerHTML on a detached element (fast)
    const mainTr = document.createElement('tr');
    mainTr.innerHTML = `
      <td><strong>${p.name}</strong></td>
      <td>${stageBadge(p.stage)}</td>
      <td class="amount">${p.price ? fmt(p.price) : '‚Äî'}</td>
      <td>${invoiceBadge(p.invoiceStatus)}</td>
      <td>${qStr}</td>
      <td>${p.country || '‚Äî'}</td>
      <td>${progHtml}</td>
      <td>
        <a href="${p.streakUrl}" target="_blank" style="color:var(--gold);font-weight:600;text-decoration:none;" onclick="event.stopPropagation()">Streak</a>
        ${p.invoiceUrl ? ` ¬∑ <a href="${p.invoiceUrl}" target="_blank" style="color:var(--green);font-weight:600;text-decoration:none;" onclick="event.stopPropagation()">Invoice</a>` : ''}
      </td>`;
    mainTr.addEventListener('click', () => _expandDetail(mainTr, p));
    frag.appendChild(mainTr);

    // Detail row ‚Äî empty placeholder, filled lazily on first click
    const detailTr = document.createElement('tr');
    const detailTd = document.createElement('td');
    detailTd.setAttribute('colspan', '8');
    detailTd.style.padding = '0';
    const detailDiv = document.createElement('div');
    detailDiv.className = 'partner-detail';
    detailDiv.id = 'detail-' + p.key;
    detailTd.appendChild(detailDiv);
    detailTr.appendChild(detailTd);
    frag.appendChild(detailTr);
  });

  if (results.length > 100) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="8" style="text-align:center;color:var(--text-light);padding:12px;">Showing first 100 of ${results.length} results ‚Äî use filters to narrow down.</td>`;
    frag.appendChild(tr);
  }

  tbody.appendChild(frag);
}

// ‚îÄ‚îÄ Deliverable completion progress (synchronous, CRM data only) ‚îÄ
function _delivProgressSimple(p) {
  const expected = PACKAGE_DELIVERABLES[p.stage];
  if (!expected) return null;
  const lookup = {};
  (p.features || []).forEach(f => {
    const name = typeof f === 'object' ? f.name : f;
    const raw  = typeof f === 'object' ? (f.timing || '') : '';
    lookup[name] = raw ? raw.split(',').map(s => s.trim()).filter(Boolean) : [];
  });
  let completed = 0, total = 0;
  expected.forEach(d => {
    if (d.alwaysYes) return;
    const timings = lookup[d.name] || [];
    const count = Math.max(d.count, timings.length || 1);
    total += count;
    const doneCount = timings.filter(t => _delivStatus(t) === 'completed').length;
    completed += Math.min(doneCount, count);
  });
  return { completed, total };
}

// ‚îÄ‚îÄ Needs Review: partners marked complete but missing live assets ‚îÄ
async function buildNeedsReview() {
  const section = document.getElementById('needs-review-section');
  if (!section) return;
  await _awaitLiveAssets();

  const flagged = [];
  const flaggedDups = [];
  const flaggedStreak = [];

  (window._allPartners || []).forEach(p => {
    const expected = PACKAGE_DELIVERABLES[p.stage];

    // Check for missing assets on completed deliverables
    if (expected) {
      const lookup = {};
      (p.features || []).forEach(f => {
        const name = typeof f === 'object' ? f.name : f;
        const raw  = typeof f === 'object' ? (f.timing || '') : '';
        lookup[name] = raw ? raw.split(',').map(s => s.trim()).filter(Boolean) : [];
      });
      const missing = [];
      expected.forEach(d => {
        // Skip deliverables that don't require an uploaded asset (e.g. Webinar ‚Äî just needs a date)
        if (d.alwaysYes || d.noAsset || d.name === 'Webinar') return;
        const timings = lookup[d.name] || [];
        const completedTimings = timings.filter(t => _delivStatus(t) === 'completed');
        if (!completedTimings.length) return;
        const hasAsset = (_liveAssets || []).some(a =>
          (a.partnerKeys || []).includes(p.key) && a.deliverable === d.name
        );
        if (!hasAsset) missing.push(d.label || d.name);
      });
      if (missing.length) flagged.push({ p, missing });
    }

    // Check for live assets whose Streak status is still "upcoming" or "none" (should be marked complete)
    if (expected) {
      const lookup2 = {};
      (p.features || []).forEach(f => {
        const name = typeof f === 'object' ? f.name : f;
        const raw  = typeof f === 'object' ? (f.timing || '') : '';
        lookup2[name] = raw ? raw.split(',').map(s => s.trim()).filter(Boolean) : [];
      });
      const needsStreakUpdate = [];
      const partnerLiveAssets = (_liveAssets || []).filter(a => (a.partnerKeys || []).includes(p.key));
      const liveDelivNames = [...new Set(partnerLiveAssets.map(a => a.deliverable))];
      liveDelivNames.forEach(delivName => {
        const d = expected.find(d => d.name === delivName);
        if (!d || d.alwaysYes || d.noAsset || d.name === 'Webinar') return;
        const timings = lookup2[delivName] || [];
        // Flag if ALL timings for this deliverable are not yet marked complete
        const hasCompleted = timings.some(t => _delivStatus(t) === 'completed');
        if (!hasCompleted) needsStreakUpdate.push(d.label || delivName);
      });
      if (needsStreakUpdate.length) flaggedStreak.push({ p, delivs: needsStreakUpdate });
    }

    // Check for duplicate assets (same deliverable + month uploaded more than once)
    const partnerAssets = (_liveAssets || []).filter(a => (a.partnerKeys || []).includes(p.key));
    const countByDelivMonth = {};
    partnerAssets.forEach(a => {
      const month = _labelMonth(a.label) || '?';
      const k = `${a.deliverable}|${month}`;
      countByDelivMonth[k] = (countByDelivMonth[k] || 0) + 1;
    });
    const dups = Object.entries(countByDelivMonth)
      .filter(([, n]) => n > 1)
      .map(([k, n]) => { const [d, m] = k.split('|'); return `${m} ${d} (√ó${n})`; });
    if (dups.length) flaggedDups.push({ p, dups });
  });

  if (!flagged.length && !flaggedDups.length && !flaggedStreak.length) {
    section.style.display = 'none';
    return;
  }

  // Remember open/closed state across rebuilds
  const wasOpen = section.dataset.bodyOpen !== 'false';
  section.style.display = '';

  const missingRows = flagged.map(({ p, missing }) => `
    <div class="nr-panel-row">
      <div>
        <strong>${p.name}</strong>
        <div class="nr-missing-list">Completed in Streak but no asset uploaded: ${missing.join(', ')}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-shrink:0;">
        ${stageBadge(p.stage)}
        <button onclick="navigateToPartner('${p.name.replace(/'/g, "\\'")}');event.stopPropagation();"
          style="background:var(--navy,#333880);color:#fff;border:none;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;">View</button>
      </div>
    </div>`).join('');

  const dupRows = flaggedDups.map(({ p, dups }) => `
    <div class="nr-panel-row">
      <div>
        <strong>${p.name}</strong>
        <div class="nr-missing-list" style="color:#870D13;">Duplicate assets uploaded: ${dups.join(', ')}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-shrink:0;">
        ${stageBadge(p.stage)}
        <button onclick="navigateToPartner('${p.name.replace(/'/g, "\\'")}');event.stopPropagation();"
          style="background:#870D13;color:#fff;border:none;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;">View</button>
      </div>
    </div>`).join('');

  const streakRows = flaggedStreak.map(({ p, delivs }) => `
    <div class="nr-panel-row">
      <div>
        <strong>${p.name}</strong>
        <div class="nr-missing-list" style="color:#333880;">Asset live but Streak not updated: ${delivs.join(', ')}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-shrink:0;">
        ${stageBadge(p.stage)}
        <button onclick="navigateToPartner('${p.name.replace(/'/g, "\\'")}');event.stopPropagation();"
          style="background:var(--navy,#333880);color:#fff;border:none;padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;">View</button>
      </div>
    </div>`).join('');

  const totalIssues = flagged.length + flaggedDups.length + flaggedStreak.length;
  section.innerHTML = `
    <div class="nr-panel">
      <div class="nr-panel-header" onclick="
        const body = this.nextElementSibling;
        const isOpen = body.style.display !== 'none';
        body.style.display = isOpen ? 'none' : '';
        this.querySelector('.nr-chevron').textContent = isOpen ? '‚ñ∂' : '‚ñº';
        this.closest('.nr-panel').closest('#needs-review-section').dataset.bodyOpen = !isOpen;
      ">
        <span style="font-size:15px;">‚ö†Ô∏è</span>
        <span>Needs Review ‚Äî ${totalIssues} issue${totalIssues !== 1 ? 's' : ''} across partners</span>
        <span class="nr-chevron" style="margin-left:auto;">${wasOpen ? '‚ñº' : '‚ñ∂'}</span>
      </div>
      <div class="nr-panel-body" style="display:${wasOpen ? '' : 'none'};">
        ${dupRows}${missingRows}${streakRows}
      </div>
    </div>
  `;
}

async function _expandDetail(rowEl, p) {
  const div = document.getElementById('detail-' + p.key);
  if (!div) return;
  // Lazy-render content only on first open
  if (!_renderedDetails.has(p.key)) {
    await _awaitLiveAssets();
    _renderedDetails.add(p.key);
    div.innerHTML = `
      <div class="detail-grid">
        <div class="detail-field"><label>Stage</label><span>${stageBadge(p.stage)}</span></div>
        <div class="detail-field"><label>Package Value</label><span>${p.price ? fmt(p.price) : '‚Äî'}</span></div>
        <div class="detail-field"><label>Invoice Status</label><span>${invoiceBadge(p.invoiceStatus)}</span></div>
        <div class="detail-field"><label>Country</label><span>${p.country || '‚Äî'}</span></div>
        <div class="detail-field"><label>Deliverable Quarter(s)</label><span>${(p.quarters||[]).length ? p.quarters.join(', ') : 'TBD'}</span></div>
        <div class="detail-field"><label>Brand</label><span>${p.brand || '‚Äî'}</span></div>
        <div class="detail-field"><label>Hotel Group</label><span>${p.group || '‚Äî'}</span></div>
        <div class="detail-field"><label>Contact Email</label><span>${p.email ? `<a href="mailto:${p.email}" style="color:var(--gold)">${p.email}</a>` : '‚Äî'}</span></div>
      </div>
      ${renderDeliverableSection(p)}
      <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <button onclick="copyPartnerLink('${p.key}',this)" style="background:var(--olive);color:#fff;border:none;padding:8px 16px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;">Copy Partner Link</button>
        <a href="partner.html?key=${p.key}" target="_blank" style="font-size:12px;color:var(--text-light);text-decoration:none;font-weight:500;">Preview portal ‚Üí</a>
      </div>`;
  }
  div.classList.toggle('open');
}

// ‚îÄ‚îÄ Goal input formatter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtGoalInput(el) {
  const pos = el.selectionStart;
  const before = el.value.length;
  const raw = el.value.replace(/[^0-9]/g, '');
  el.value = raw ? parseInt(raw).toLocaleString() : '';
  // Restore cursor roughly (shift by inserted commas)
  const diff = el.value.length - before;
  el.setSelectionRange(pos + diff, pos + diff);
}

// ‚îÄ‚îÄ Deliverable view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PACKAGE_DELIVERABLES = {
  'Tier 1': [
    { name: 'Collection',  label: 'Collection Inclusion', count: 1 },
    { name: 'Newsletter',  label: 'Newsletter Feature',   count: 1 },
    { name: 'Forum',       label: 'Forum Feature',        count: 1 },
  ],
  'Tier 2': [
    { name: 'Collection',    label: 'Collection Inclusion', count: 2 },
    { name: 'Newsletter',    label: 'Newsletter Feature',   count: 1 },
    { name: 'Forum',         label: 'Forum Feature',        count: 2 },
    { name: 'Advisor Assets',label: 'Advisor Assets',       count: 1 },
  ],
  'Brand Spotlight': [
    { name: 'Collection',    label: 'Collection Feature',        count: 1 },
    { name: 'Webinar',       label: 'Webinar',                   count: 1, noAsset: true },
    { name: 'Advisor Assets',label: 'Advisor Assets',            count: 1 },
    { name: 'Forum',         label: 'Live Forum Pre-Sale Access', count: 1, alwaysYes: true },
  ],
  'New Opening': [
    { name: 'Collection',  label: 'Collection Feature',  count: 1 },
    { name: 'Social Media',label: 'Social Media Feature', count: 1 },
    { name: 'Forum',       label: 'Forum Post',           count: 1 },
  ],
};

const _MONTHS = {
  january:0, jan:0, february:1, feb:1, march:2, mar:2,
  april:3, apr:3, may:4, june:5, jun:5, july:6, jul:6,
  august:7, aug:7, september:8, sep:8, october:9, oct:9,
  november:10, nov:10, december:11, dec:11,
};

function _parseDelivDate(str) {
  if (!str) return null;
  const s = str.toLowerCase();
  for (const [name, idx] of Object.entries(_MONTHS)) {
    if (s.includes(name)) {
      const y = s.match(/\d{4}/);
      return new Date(y ? +y[0] : 2026, idx, 1);
    }
  }
  const q = s.match(/q([1-4])/);
  if (q) {
    const y = s.match(/\d{4}/);
    return new Date(y ? +y[0] : 2026, (parseInt(q[1]) - 1) * 3, 1);
  }
  return null;
}

function _delivStatus(timing) {
  if (!timing || !timing.trim()) return 'none';
  const t = timing.toLowerCase();
  // Labels from Streak TAG/DROPDOWN fields are "Month - Planned" or "Month - Completed"
  if (t.includes('completed')) return 'completed';
  if (t.includes('planned'))   return 'upcoming';
  // DATE-type fields (Webinar) come through as "March 2026" ‚Äî use date comparison
  const d = _parseDelivDate(timing);
  if (!d) return 'upcoming';
  const now = new Date();
  return d.getFullYear() * 12 + d.getMonth() < now.getFullYear() * 12 + now.getMonth()
    ? 'completed' : 'upcoming';
}

function _scheduledLabel(timing) {
  // "March - Planned" ‚Üí "March", "March 2026" ‚Üí "March 2026", "" ‚Üí "‚Äî"
  if (!timing || !timing.trim()) return '‚Äî';
  const dash = timing.indexOf(' - ');
  return dash > 0 ? timing.substring(0, dash).trim() : timing;
}

function renderDeliverableSection(p) {
  const expected = PACKAGE_DELIVERABLES[p.stage];

  // No package definition ‚Äî fall back to raw feature badges (pipeline stages etc.)
  if (!expected) {
    const feats = p.features || [];
    if (!feats.length) return '';
    return `<div style="margin-top:14px;">
      <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--text-light);">Deliverables</label>
      <div class="feature-tags" style="margin-top:6px;">${feats.map(f => {
        const name   = typeof f === 'object' ? f.name : f;
        const timing = typeof f === 'object' && f.timing ? f.timing : '';
        return `<span class="badge badge-navy">${name}${timing ? `<span style="font-weight:400;opacity:0.75"> ¬∑ ${timing}</span>` : ''}</span>`;
      }).join('')}</div>
    </div>`;
  }

  // Build lookup: feature name ‚Üí [timing1, timing2, ...]
  const lookup = {};
  (p.features || []).forEach(f => {
    const name = typeof f === 'object' ? f.name : f;
    const raw  = typeof f === 'object' ? (f.timing || '') : '';
    lookup[name] = raw ? raw.split(',').map(s => s.trim()).filter(Boolean) : [];
  });

  const STATUS_BADGE = {
    completed: `<span class="badge badge-green">‚úì Completed</span>`,
    upcoming:  `<span class="badge badge-amber">Upcoming</span>`,
    none:      `<span class="badge badge-gray">Not yet planned</span>`,
  };

  // Build asset lookup: deliverable name ‚Üí [asset, ...]
  const assetsByDeliv = {};
  (_liveAssets || []).filter(a => (a.partnerKeys || []).includes(p.key)).forEach(a => {
    if (!assetsByDeliv[a.deliverable]) assetsByDeliv[a.deliverable] = [];
    assetsByDeliv[a.deliverable].push(a);
  });

  const hasAnyAssets = Object.keys(assetsByDeliv).length > 0;

  function assetCellHtml(delivName) {
    const assets = assetsByDeliv[delivName] || [];
    if (!assets.length) return '<td style="padding:9px 14px;"></td>';
    const links = assets.map(a => {
      if (a.assetType === 'url' || (!a.path && a.url)) {
        return `<a href="${a.url}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;font-size:12px;color:var(--olive);font-weight:600;text-decoration:none;">üîó <span>${a.label || 'View'}</span></a>`;
      }
      const isPdf = a.path && a.path.toLowerCase().endsWith('.pdf');
      if (isPdf) {
        return `<a href="${a.path}" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:5px;font-size:12px;color:var(--olive);font-weight:600;text-decoration:none;">üìÑ <span>${a.label || 'View PDF'}</span></a>`;
      }
      return `<a href="${a.path}" target="_blank" rel="noopener" title="${a.label || delivName}">
        <img src="${a.path}" style="width:56px;height:40px;object-fit:cover;border-radius:5px;border:1px solid var(--border);display:block;" onerror="this.style.display='none'">
      </a>`;
    }).join('<span style="margin:0 4px;color:var(--border);">|</span>');
    return `<td style="padding:9px 14px;">${links}</td>`;
  }

  let rows = '';
  expected.forEach(d => {
    if (d.alwaysYes) {
      rows += `
        <tr style="border-bottom:1px solid var(--border);">
          <td style="padding:9px 14px;font-size:13px;">${d.label}</td>
          <td style="padding:9px 14px;font-size:13px;color:var(--text-light);">‚Äî</td>
          <td style="padding:9px 14px;"><span class="badge badge-green">‚úì Included</span></td>
          ${hasAnyAssets ? '<td style="padding:9px 14px;"></td>' : ''}
        </tr>`;
      return;
    }
    const timings = lookup[d.name] || [];
    for (let i = 0; i < d.count; i++) {
      const t      = timings[i] || '';
      const suffix = d.count > 1
        ? ` <span style="color:var(--text-light);font-size:11px;font-weight:400;">(${i + 1} of ${d.count})</span>`
        : '';
      rows += `
        <tr style="border-bottom:1px solid var(--border);">
          <td style="padding:9px 14px;font-size:13px;">${d.label}${suffix}</td>
          <td style="padding:9px 14px;font-size:13px;color:var(--text-light);">${_scheduledLabel(t)}</td>
          <td style="padding:9px 14px;">${STATUS_BADGE[_delivStatus(t)]}</td>
          ${hasAnyAssets ? (i === 0 ? assetCellHtml(d.name) : '<td style="padding:9px 14px;"></td>') : ''}
        </tr>`;
    }
  });

  return `
    <div style="margin-top:16px;">
      <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--text-light);display:block;margin-bottom:8px;">Deliverables</label>
      <table style="width:100%;border-collapse:collapse;">
        <thead>
          <tr style="border-bottom:2px solid var(--border);">
            <th style="text-align:left;padding:6px 14px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--text-light);">Deliverable</th>
            <th style="text-align:left;padding:6px 14px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--text-light);">Scheduled</th>
            <th style="text-align:left;padding:6px 14px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--text-light);">Status</th>
            ${hasAnyAssets ? '<th style="text-align:left;padding:6px 14px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--text-light);">Published Content</th>' : ''}
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

// ‚îÄ‚îÄ Scenario Planner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PKG_DEFAULTS = {
  'Tier 1':             { price: 4000,  color: OLIVE  },
  'Tier 2':             { price: 8000,  color: INDIGO },
  'Brand Spotlight':    { price: 10000, color: BLACK  },
  'New Opening':        { price: 6000,  color: STONE  },
  'Marketing Complete': { price: 4000,  color: DSHELL },
};

function initPlanner(D) {
  // Build pricing table from actual averages
  const tbody = document.getElementById('pkgPricingTable');
  Object.entries(PKG_DEFAULTS).forEach(([pkg, def]) => {
    const count = (D.countByStage || {})[pkg] || 0;
    const rev   = (D.byStage || {})[pkg] || 0;
    const avg   = def.price;
    tbody.innerHTML += `
      <tr>
        <td><span class="badge" style="background:${def.color}22;color:${def.color};border:1px solid ${def.color}55;">${pkg}</span></td>
        <td><input type="number" class="pkg-price-input" id="price-${pkg.replace(/ /g,'_')}" value="${avg}" step="500" oninput="updatePlanner()"></td>
        <td style="font-weight:700;">${count}</td>
        <td class="amount">${rev ? fmt(rev) : '‚Äî'}</td>
      </tr>`;
  });
  updatePlanner();
}

function getPkgPrice(pkg) {
  const el = document.getElementById('price-' + pkg.replace(/ /g, '_'));
  return el ? parseInt(el.value) || PKG_DEFAULTS[pkg]?.price || 0 : 0;
}

function updatePlanner() {
  if (typeof AMPLIFY_DATA === 'undefined') return;
  const D    = AMPLIFY_DATA;
  const goal = parseInt((document.getElementById('goalInput').value || '').replace(/[^0-9]/g, '')) || 1500000;
  const signed = D.totalSigned;
  const gap    = Math.max(0, goal - signed);
  const pctVal = Math.min(100, Math.round(signed / goal * 100));

  document.getElementById('plannerPct').textContent        = pctVal + '%';
  document.getElementById('plannerProgressBar').style.width = pctVal + '%';
  document.getElementById('plannerSignedLabel').textContent = fmt(signed) + ' signed';
  document.getElementById('plannerGoalLabel').textContent   = fmt(goal) + ' goal';
  document.getElementById('plannerGap').textContent         = gap > 0 ? fmt(gap) : '‚úì Goal reached!';
  document.getElementById('plannerGap').style.color         = gap > 0 ? RED : GREEN;
  document.getElementById('plannerPipelineAvail').textContent = fmt(D.inDiscussion + D.finalFollowUp);

  // Scenarios
  const t1Price  = getPkgPrice('Tier 1');
  const t2Price  = getPkgPrice('Tier 2');
  const bsPrice  = getPkgPrice('Brand Spotlight');
  const noPrice  = getPkgPrice('New Opening');

  const scenarios = [];
  if (gap <= 0) {
    scenarios.push({ title: 'üéâ Goal already reached!', rows: [{ pkg: 'Total signed', qty: fmt(signed) + ' / ' + fmt(goal) }] });
  } else {
    // Scenario A: Tier 1 only
    scenarios.push({
      title: 'Scenario A ‚Äî Close with Tier 1 only',
      rows: [{ pkg: 'Tier 1 packages needed', qty: Math.ceil(gap / t1Price) + ' more @ ' + fmt(t1Price) }]
    });
    // Scenario B: Balanced (same current ratio, excluding Marketing Complete)
    const totalCnt = (D.countByStage['Tier 1']||0) + (D.countByStage['Tier 2']||0) +
                     (D.countByStage['Brand Spotlight']||0) + (D.countByStage['New Opening']||0);
    if (totalCnt > 0) {
      const r1 = (D.countByStage['Tier 1']||0) / totalCnt;
      const r2 = (D.countByStage['Tier 2']||0) / totalCnt;
      const rBS = (D.countByStage['Brand Spotlight']||0) / totalCnt;
      const rNO = (D.countByStage['New Opening']||0) / totalCnt;
      const avgPriceBalanced = r1*t1Price + r2*t2Price + rBS*bsPrice + rNO*noPrice;
      const totalNew = Math.ceil(gap / avgPriceBalanced);
      scenarios.push({
        title: 'Scenario B ‚Äî Same mix as current',
        rows: [
          { pkg: 'Tier 1', qty: Math.ceil(totalNew * r1) + ' more' },
          { pkg: 'Brand Spotlight', qty: Math.ceil(totalNew * rBS) + ' more' },
          { pkg: 'Tier 2', qty: Math.ceil(totalNew * r2) + ' more' },
          { pkg: 'New Opening', qty: Math.ceil(totalNew * rNO) + ' more' },
          { pkg: 'Total new partners', qty: '~' + totalNew },
        ]
      });
    }
    // Scenario C: Premium focus (50% BS, 30% T2, 20% T1)
    const avgPricePremium = 0.5*bsPrice + 0.3*t2Price + 0.2*t1Price;
    const premiumTotal = Math.ceil(gap / avgPricePremium);
    scenarios.push({
      title: 'Scenario C ‚Äî Premium focus (more Brand Spotlight & Tier 2)',
      rows: [
        { pkg: 'Brand Spotlight (50%)', qty: Math.ceil(premiumTotal * 0.5) + ' more @ ' + fmt(bsPrice) },
        { pkg: 'Tier 2 (30%)', qty: Math.ceil(premiumTotal * 0.3) + ' more @ ' + fmt(t2Price) },
        { pkg: 'Tier 1 (20%)', qty: Math.ceil(premiumTotal * 0.2) + ' more @ ' + fmt(t1Price) },
        { pkg: 'Total new partners', qty: '~' + premiumTotal },
      ]
    });
  }

  const sl = document.getElementById('scenarioList');
  sl.innerHTML = '';
  scenarios.forEach(s => {
    sl.innerHTML += `
      <div class="scenario-card">
        <h4>${s.title}</h4>
        <div class="scenario-rows">
          ${s.rows.map(r => `<div class="scenario-row"><span class="pkg">${r.pkg}</span><span class="qty">${r.qty}</span></div>`).join('')}
        </div>
      </div>`;
  });

  // Fill rate table
  const fillEl = document.getElementById('fillRateTable');
  const maxRev  = Math.max(...Object.keys(PKG_DEFAULTS).map(pkg => (AMPLIFY_DATA.byStage || {})[pkg] || 0));
  fillEl.innerHTML = `
    <table class="pkg-table">
      <thead><tr><th>Package</th><th>Signed</th><th>Avg price</th><th>Revenue</th><th>Share of total signed</th></tr></thead>
      <tbody>
        ${Object.entries(PKG_DEFAULTS).map(([pkg]) => {
          const count   = (AMPLIFY_DATA.countByStage || {})[pkg] || 0;
          const rev     = (AMPLIFY_DATA.byStage || {})[pkg] || 0;
          const avg     = count > 0 ? fmt(Math.round(rev / count)) : '‚Äî';
          const sharePct = AMPLIFY_DATA.totalSigned > 0 ? Math.round(rev / AMPLIFY_DATA.totalSigned * 100) : 0;
          const barW    = maxRev > 0 ? Math.round(rev / maxRev * 100) : 0;
          return `
            <tr>
              <td>${stageBadge(pkg)}</td>
              <td style="font-weight:700;">${count}</td>
              <td class="amount" style="color:var(--text-light);">${avg}</td>
              <td class="amount">${fmt(rev)}</td>
              <td style="min-width:160px;">
                <div style="display:flex;align-items:center;gap:8px;">
                  <div class="mini-progress" style="flex:1;"><div class="mini-progress-fill" style="width:${barW}%"></div></div>
                  <span style="font-size:12px;font-weight:700;color:var(--text);width:32px;text-align:right;">${sharePct}%</span>
                </div>
              </td>
            </tr>`;
        }).join('')}
      </tbody>
    </table>`;
}

// ‚îÄ‚îÄ Next Steps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildNextSteps(D) {
  const steps = [
    {
      title: `Invoice ${fmt(D.needsInvoice)} in signed partners`,
      body: `${D.needsInvoiceCount} signed partner${D.needsInvoiceCount !== 1 ? 's' : ''} with contracts but no invoice yet. Get these out this week to start the payment clock.`,
      tag: 'urgent'
    },
    {
      title: `Follow up on ${fmt(D.outstanding)} in outstanding invoices`,
      body: `Invoices sent but not yet paid. Prioritize higher-value Tier 2 and Brand Spotlight partners. Anyone 30+ days past invoice date should get a friendly payment reminder.`,
      tag: 'urgent'
    },
    ...(D.waitingBilling > 0 ? [{
      title: `Collect billing details (${fmt(D.waitingBilling)})`,
      body: `Revenue is stuck in "Waiting for billing details" status. A quick email nudge can unblock these invoices.`,
      tag: 'this-week'
    }] : []),
    {
      title: `Convert ${D.inDiscussionCount} In-Discussion partners`,
      body: `${fmt(D.inDiscussion)} in potential revenue is scoped. Prioritize those with quotes already sent and focus on closing before Q1 deliverables begin.`,
      tag: 'this-week'
    },
    ...((D.quarters?.TBD || 0) > 0 ? [{
      title: `Assign deliverable quarters for ${D.quarters.TBD} partners`,
      body: `${D.quarters.TBD} signed partners don't have a quarter preference recorded. Critical for scheduling content in Q1 and Q2.`,
      tag: 'this-week'
    }] : []),
    {
      title: `Review Final Follow Up stage (${D.finalFollowUpCount} partners)`,
      body: `${D.finalFollowUpCount} partners in Final Follow Up. These are your last chances to convert before they go cold.`,
      tag: 'this-week'
    },
    {
      title: 'Plan Q1 content delivery calendar',
      body: `${D.quarters?.Q1 || 0} partners want Q1 deliverables, ${D.quarters?.Q2 || 0} want Q2. Confirm scheduling with the content team now to avoid a crunch.`,
      tag: 'ongoing'
    },
  ];

  const grid = document.getElementById('nextStepsGrid');
  const tagLabels = { urgent: 'Urgent', 'this-week': 'This week', ongoing: 'Ongoing', nice: 'Quick win' };
  steps.forEach((s, i) => {
    grid.innerHTML += `
      <div class="next-step-card">
        <div class="step-number">${i+1}</div>
        <div class="step-content">
          <h4>${s.title}</h4>
          <p>${s.body}</p>
          <span class="step-tag ${s.tag}">${tagLabels[s.tag]}</span>
        </div>
      </div>`;
  });
}

// ‚îÄ‚îÄ Team Updates ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildTeamUpdates(D) {
  const paidPct = D.totalSigned > 0 ? Math.round(D.paid / D.totalSigned * 100) : 0;
  const updates = [
    { dot: 'gold',  text: `<strong>${D.signedCount} partners signed</strong> for Amplify 2026 ‚Äî Tier 1 leads with ${D.countByStage?.['Tier 1'] || 0} properties. Strong growth across top hotel groups.` },
    { dot: 'green', text: `<strong>${fmt(D.paid)} collected</strong> ‚Äî ${paidPct}% of total signed value paid.` },
    { dot: 'amber', text: `<strong>${fmt(D.outstanding)} outstanding</strong> in sent invoices awaiting payment. Following up is the highest-value action this week.` },
    { dot: 'navy',  text: `<strong>${D.inDiscussionCount} partners in active discussion</strong> ‚Äî ${fmt(D.inDiscussion)} in additional revenue potential.` },
    ...(D.waitingBilling > 0 ? [{ dot: 'amber', text: `<strong>${fmt(D.waitingBilling)} waiting on billing details</strong> ‚Äî quick follow-ups needed to unblock invoicing.` }] : []),
  ];

  const ul = document.getElementById('updateList');
  updates.forEach(u => {
    ul.innerHTML += `
      <div class="update-item">
        <div class="update-dot ${u.dot}"></div>
        <div class="update-text">${u.text}</div>
      </div>`;
  });

  // Snapshot
  const snapshot = buildSnapshot(D);
  document.getElementById('copySnapshot').textContent = snapshot;
}

function buildSnapshot(D) {
  const paidPct = D.totalSigned > 0 ? Math.round(D.paid/D.totalSigned*100) : 0;
  const byStage = Object.entries(D.byStage || {}).map(([k,v]) => `  ‚Ä¢ ${k}: ${fmt(v)} (${D.countByStage?.[k] || 0})`).join('\n');
  const topGroups = (D.topGroups || []).slice(0,3).map(([l,c]) => `${l} (${c})`).join(', ');
  const topCountries = (D.topCountries || []).slice(0,3).map(([l,c]) => `${l} (${c})`).join(', ');
  return `FORA AMPLIFY 2026 ‚Äî WEEKLY SNAPSHOT
${D.lastUpdated}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SIGNED PARTNERS: ${D.signedCount}
${byStage}

SIGNED VALUE: ${fmt(D.totalSigned)}  |  TOTAL PIPELINE: ${fmt(D.totalPipeline)}

INVOICE STATUS:
  ‚Ä¢ Paid:            ${fmt(D.paid)} (${paidPct}%)
  ‚Ä¢ Outstanding:     ${fmt(D.outstanding)}
  ‚Ä¢ Waiting Billing: ${fmt(D.waitingBilling)}
  ‚Ä¢ Needs Invoice:   ${fmt(D.needsInvoice)} (${D.needsInvoiceCount} partners)

PIPELINE:
  ‚Ä¢ In Discussion:   ${fmt(D.inDiscussion)} (${D.inDiscussionCount} partners)
  ‚Ä¢ Final Follow Up: ${fmt(D.finalFollowUp)} (${D.finalFollowUpCount} partners)

DELIVERABLES: Q1: ${D.quarters?.Q1||0}  |  Q2: ${D.quarters?.Q2||0}  |  Q3: ${D.quarters?.Q3||0}  |  TBD: ${D.quarters?.TBD||0}

TOP GROUPS: ${topGroups}
TOP COUNTRIES: ${topCountries}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`;
}

function copySnapshot() {
  const notes = document.getElementById('weeklyNotes').value;
  const base  = buildSnapshot(AMPLIFY_DATA);
  const full  = base + (notes ? '\n\nTEAM NOTES:\n' + notes : '');
  navigator.clipboard.writeText(full).then(() => {
    const btn = event.target;
    btn.textContent = 'Copied!';
    btn.style.background = OLIVE;
    setTimeout(() => { btn.textContent = 'Copy Summary'; btn.style.background = ''; }, 2000);
  });
}

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
init();
const _savedTab = localStorage.getItem('amplifyTab');
if (_savedTab) {
  const _savedTabEl = document.querySelector(`.nav-tab[onclick*="'${_savedTab}'"]`);
  showTab(_savedTab, _savedTabEl);
}
</script>
</body>
</html>
